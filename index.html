<!doctype html>
<html lang="pt" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Convites PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
    
    * {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .gradient-bg {
      background: #ffffff;
    }
    
    .card-shadow {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: #007f9f;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 127, 159, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #e6f4f7;
      color: #007f9f;
      transition: all 0.2s;
    }
    
    .btn-secondary:hover {
      background: #cce8ed;
    }
    
    .btn-danger {
      background: #fee2e2;
      color: #dc2626;
      transition: all 0.2s;
    }
    
    .btn-danger:hover {
      background: #fecaca;
    }
    
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #007f9f;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .pdf-preview-container {
      border: 2px dashed #cce8ed;
      border-radius: 12px;
      background: #f9fafb;
      position: relative;
      overflow: hidden;
    }
    
    .draggable-text {
      cursor: move;
      position: absolute;
      user-select: none;
      padding: 8px 16px;
      border: 2px solid #007f9f;
      background: rgba(0, 127, 159, 0.2);
      border-radius: 6px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      pointer-events: auto;
      white-space: nowrap;
    }
    
    .draggable-text:active {
      cursor: move;
    }
    
    .token-display {
      background: #1f2937;
      color: #10b981;
      font-family: 'Courier New', monospace;
      padding: 12px;
      border-radius: 8px;
      word-break: break-all;
      font-size: 13px;
    }
    
    .pdf-canvas-wrapper {
      position: relative;
      display: inline-block;
      margin: 0 auto;
    }
    
    #pdfCanvas {
      display: block;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .sidebar {
      width: 350px;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      background: white;
      border-right: 2px solid #e5e7eb;
      overflow-y: auto;
      z-index: 100;
    }
    
    .main-content {
      margin-left: 350px;
      min-height: 100vh;
    }
    
    .sidebar-item {
      padding: 16px 20px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .sidebar-item label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    
    .sidebar-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .sidebar-input:focus {
      outline: none;
      border-color: #007f9f;
    }
    
    .sidebar-btn {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .event-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .event-card:hover {
      border-color: #007f9f;
      box-shadow: 0 4px 12px rgba(0, 127, 159, 0.1);
    }
    
    .event-card.selected {
      border-color: #007f9f;
      background: #e6f4f7;
    }
    
    .invite-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    
    .invite-item:hover {
      background: #f3f4f6;
      border-color: #007f9f;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full"></div>
  <script>
    // ==========================================
    // SUPABASE INICIALIZA√á√ÉO
    // ==========================================
    const SUPABASE_URL = 'https://okevdjxksctbkxtonllq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZXZkanhrc2N0Ymt4dG9ubGxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNDE2OTgsImV4cCI6MjA4NDkxNzY5OH0.g8XGFbcTeR0NosiQqjMbbshDF1Xx9hHUWWPxHJe6hAc';
    
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      db: { schema: 'public' },
      global: { headers: { 'Prefer': 'return=representation' } }
    });
    
    // ==========================================
    // CONSTANTES
    // ==========================================
    const STORAGE_BUCKET = 'invites';
// ADMIN_CREDENTIALS removido ‚Äì autentica√ß√£o via Supabase Auth
    
    // ==========================================
    // ESTADO GLOBAL
    // ==========================================
    let currentView = 'home';
    let currentToken = null;
    let isAdminAuthenticated = false;
    let selectedEventId = null;
    
    // Vari√°veis tempor√°rias APENAS durante cria√ß√£o
    let tempPdfBytes = null;
    let tempFontBytes = null;
    let tempFontName = null;
    
    // Canvas rendering
    let currentRenderTask = null;
    let canvasScale = 1;
    let pdfPageDimensions = { width: 986.32, height: 1810.08 };
    
    // Drag & Drop
    let draggedElement = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    
    // Realtime subscription
    let realtimeChannel = null;

    // ==========================================
    // SUPABASE STORAGE - OPERA√á√ïES
    // ==========================================
    const Storage = {
      // EVENTOS
      async getEvents() {
        try {
          const { data, error } = await supabaseClient
            .from('events')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Erro ao buscar eventos:', error);
          return [];
        }
      },
      
      async saveEvent(event) {
        try {
          event.created_at = new Date().toISOString();
          event.active = true;
          
          const { data, error } = await supabaseClient
            .from('events')
            .insert([event])
            .select()
            .single();
          
          if (error) throw error;
          
          console.log('‚úÖ Evento criado:', data.id);
          return data;
        } catch (error) {
          console.error('Erro ao criar evento:', error);
          throw error;
        }
      },
      
      async updateEvent(eventId, updates) {
        try {
          const { data, error } = await supabaseClient
            .from('events')
            .update(updates)
            .eq('id', eventId)
            .select()
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Erro ao atualizar evento:', error);
          throw error;
        }
      },
      
      async getEvent(id) {
        try {
          const { data, error } = await supabaseClient
            .from('events')
            .select('*')
            .eq('id', id)
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Erro ao buscar evento:', error);
          return null;
        }
      },
      
      async getEventByToken(token) {
        try {
          const { data, error } = await supabaseClient
            .from('events')
            .select('*')
            .eq('token', token)
            .single();
          
          if (error) throw error;
          return data;
        } catch (error) {
          console.error('Erro ao buscar evento por token:', error);
          return null;
        }
      },
      
      async deleteEvent(id) {
        try {
          const event = await this.getEvent(id);
          
          if (event && event.pdf_path) {
            const { error: storageError } = await supabaseClient.storage
              .from(STORAGE_BUCKET)
              .remove([event.pdf_path]);
            
            if (storageError) {
              console.warn('Erro ao deletar PDF do storage:', storageError);
            }
          }
          
          if (event && event.font_path) {
            const { error: fontError } = await supabaseClient.storage
              .from(STORAGE_BUCKET)
              .remove([event.font_path]);
            
            if (fontError) {
              console.warn('Erro ao deletar fonte do storage:', fontError);
            }
          }
          
          await supabaseClient
            .from('invites')
            .delete()
            .eq('event_id', id);
          
          const { error } = await supabaseClient
            .from('events')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
          console.log('‚úÖ Evento deletado');
        } catch (error) {
          console.error('Erro ao deletar evento:', error);
          throw error;
        }
      },
      
      // CONVITES
      async getInvites(eventId = null) {
        try {
          let query = supabaseClient
            .from('invites')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (eventId) {
            query = query.eq('event_id', eventId);
          }
          
          const { data, error } = await query;
          
          if (error) throw error;
          return data || [];
        } catch (error) {
          console.error('Erro ao buscar convites:', error);
          return [];
        }
      },
      
      async saveInvite(invite) {
        try {
          invite.created_at = new Date().toISOString();
          invite.pdf_base64 = '';
          
          const { data, error } = await supabaseClient
            .from('invites')
            .insert([invite])
            .select()
            .single();
          
          if (error) throw error;
          
          console.log('‚úÖ Convite salvo:', data.id);
          return data;
        } catch (error) {
          console.error('Erro ao salvar convite:', error);
          throw error;
        }
      },
      
      async getInviteByGuestName(eventId, guestName) {
        try {
          const { data, error } = await supabaseClient
            .from('invites')
            .select('*')
            .eq('event_id', eventId)
            .eq('guest_name', guestName)
            .single();
          
          if (error && error.code !== 'PGRST116') throw error;
          return data || null;
        } catch (error) {
          console.error('Erro ao buscar convite:', error);
          return null;
        }
      },
      
      // SUPABASE STORAGE
      async uploadPdf(eventId, pdfBytes) {
        try {
          const path = `events/${eventId}/base.pdf`;
          
          console.log('üì§ Enviando PDF para storage:', path);
          
          const { data, error } = await supabaseClient.storage
            .from(STORAGE_BUCKET)
            .upload(path, pdfBytes, {
              contentType: 'application/pdf',
              upsert: true
            });
          
          if (error) throw error;
          
          console.log('‚úÖ PDF enviado com sucesso');
          return path;
        } catch (error) {
          console.error('‚ùå Erro ao enviar PDF:', error);
          throw error;
        }
      },
      
      async uploadFont(eventId, fontBytes, fontName) {
        try {
          const ext = fontName.substring(fontName.lastIndexOf('.'));
          const path = `events/${eventId}/font${ext}`;
          
          console.log('üì§ Enviando fonte para storage:', path);
          
          const { data, error } = await supabaseClient.storage
            .from(STORAGE_BUCKET)
            .upload(path, fontBytes, {
              contentType: 'application/octet-stream',
              upsert: true
            });
          
          if (error) throw error;
          
          console.log('‚úÖ Fonte enviada com sucesso');
          return path;
        } catch (error) {
          console.error('‚ùå Erro ao enviar fonte:', error);
          throw error;
        }
      },
      
      async downloadPdf(pdfPath) {
        try {
          console.log('üì• Baixando PDF do storage:', pdfPath);
          
          const { data, error } = await supabaseClient.storage
            .from(STORAGE_BUCKET)
            .download(pdfPath);
          
          if (error) throw error;
          
          const arrayBuffer = await data.arrayBuffer();
          const pdfBytes = new Uint8Array(arrayBuffer);
          
          console.log('‚úÖ PDF baixado:', pdfBytes.length, 'bytes');
          return pdfBytes;
        } catch (error) {
          console.error('‚ùå Erro ao baixar PDF:', error);
          throw error;
        }
      },
      
      async downloadFont(fontPath) {
        try {
          console.log('üì• Baixando fonte do storage:', fontPath);
          
          const { data, error } = await supabaseClient.storage
            .from(STORAGE_BUCKET)
            .download(fontPath);
          
          if (error) throw error;
          
          const arrayBuffer = await data.arrayBuffer();
          const fontBytes = new Uint8Array(arrayBuffer);
          
          console.log('‚úÖ Fonte baixada:', fontBytes.length, 'bytes');
          return fontBytes;
        } catch (error) {
          console.error('‚ùå Erro ao baixar fonte:', error);
          throw error;
        }
      }
    };

    // ==========================================
    // UTILIT√ÅRIOS
    // ==========================================
    function generateToken() {
      return Math.floor(10000000 + Math.random() * 90000000).toString();
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16) / 255,
        g: parseInt(result[2], 16) / 255,
        b: parseInt(result[3], 16) / 255
      } : { r: 0, g: 0, b: 0 };
    }

    function removeAccents(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-xl text-white font-semibold shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      toast.style.animation = 'slideIn 0.3s ease-out';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // ==========================================
    // AUTENTICA√á√ÉO
    // ==========================================
    async function handleAdminLogin(e) {
      e.preventDefault();

      const email = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      const { error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        showToast('Credenciais inv√°lidas', 'error');
        return;
      }

      isAdminAuthenticated = true;

      if (rememberMe) {
        localStorage.setItem('adminAuth', 'true');
      } else {
        sessionStorage.setItem('adminAuth', 'true');
      }

      showToast('Login bem-sucedido!', 'success');
      goToAdmin();
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      isAdminAuthenticated = false;
      sessionStorage.removeItem('adminAuth');
      localStorage.removeItem('adminAuth');
      selectedEventId = null;
      goToHome();
    }

    // ==========================================

    // CONVERS√ÉO DE COORDENADAS
    // ==========================================
    function convertPixelsToPoints(pxX, pxY, canvasWidth, canvasHeight) {
      const ptX = (pxX / canvasWidth) * pdfPageDimensions.width;
      const ptY = pdfPageDimensions.height - ((pxY / canvasHeight) * pdfPageDimensions.height);
      return { x: ptX, y: ptY };
    }

    // ==========================================
    // RENDERIZA√á√ÉO DO PDF
    // ==========================================
    async function renderPdfOnCanvas(pdfBytes, pageNumber) {
      try {
        if (currentRenderTask) {
          try {
            await currentRenderTask.cancel();
          } catch (e) {
            // Ignorar erro de cancelamento
          }
          currentRenderTask = null;
        }
        
        const pdfDocument = await PDFLib.PDFDocument.load(pdfBytes);
        const pages = pdfDocument.getPages();
        const totalPages = pages.length;
        
        const currentPage = pages[pageNumber - 1];
        
        if (!currentPage) {
          showToast('P√°gina n√£o encontrada no PDF', 'error');
          return;
        }
        
        const { width, height } = currentPage.getSize();
        pdfPageDimensions = { width, height };
        
        const canvas = document.getElementById('pdfCanvas');
        
        if (!canvas) {
          console.warn('‚ö†Ô∏è Canvas n√£o encontrado');
          return;
        }
        
        canvasScale = 1;
        
        if (typeof pdfjsLib !== 'undefined') {
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
        const pdfDoc = await loadingTask.promise;
        const page = await pdfDoc.getPage(pageNumber);
        
        const viewport = page.getViewport({ scale: 1 });
        
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        
        const ctx = canvas.getContext('2d');
        
        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        
        currentRenderTask = page.render(renderContext);
        
        await currentRenderTask.promise;
        currentRenderTask = null;
        
        updatePageNavigation(pageNumber, totalPages);
        
        return { width: canvas.width, height: canvas.height };
      } catch (error) {
        console.error('Erro ao renderizar PDF:', error);
        if (error.message && !error.message.includes('cancel')) {
          showToast('Erro ao carregar PDF', 'error');
        }
      }
    }
    
    function updatePageNavigation(currentPage, totalPages) {
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      if (pageInfo) {
        pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
      }
      
      if (prevBtn) {
        prevBtn.disabled = currentPage <= 1;
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentPage >= totalPages;
      }
    }
    
    async function changePage(direction) {
      if (!selectedEventId) return;
      
      const event = await Storage.getEvent(selectedEventId);
      if (!event || !event.pdf_path) return;
      
      const pdfBytes = await Storage.downloadPdf(event.pdf_path);
      const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
      const totalPages = pdfDoc.getPages().length;
      
      let newPage = event.page_number + direction;
      
      if (newPage < 1) newPage = 1;
      if (newPage > totalPages) newPage = totalPages;
      
      if (newPage === event.page_number) return;
      
      await Storage.updateEvent(selectedEventId, { page_number: newPage });
      
      await renderPdfOnCanvas(pdfBytes, newPage);
      
      const draggableText = document.getElementById('draggableText');
      const canvas = document.getElementById('pdfCanvas');
      
      if (draggableText && canvas) {
        const pxY = canvas.height - ((event.position_y_pt / pdfPageDimensions.height) * canvas.height);
        draggableText.style.top = pxY + 'px';
        
        updateDraggablePosition(event);
      }
    }

    async function changePageCreate(direction) {
      if (!tempPdfBytes) return;
      
      const pdfDoc = await PDFLib.PDFDocument.load(tempPdfBytes);
      const totalPages = pdfDoc.getPages().length;
      
      const pageNumberInput = document.getElementById('pageNumber');
      let currentPage = parseInt(pageNumberInput.value) || 1;
      let newPage = currentPage + direction;
      
      if (newPage < 1) newPage = 1;
      if (newPage > totalPages) newPage = totalPages;
      
      if (newPage === currentPage) return;
      
      pageNumberInput.value = newPage;
      
      await renderPdfOnCanvas(tempPdfBytes, newPage);
      
      const pageInfo = document.getElementById('pageInfoCreate');
      const prevBtn = document.getElementById('prevPageCreate');
      const nextBtn = document.getElementById('nextPageCreate');
      
      if (pageInfo) {
        pageInfo.textContent = `P√°gina ${newPage} de ${totalPages}`;
      }
      
      if (prevBtn) {
        prevBtn.disabled = newPage <= 1;
      }
      
      if (nextBtn) {
        nextBtn.disabled = newPage >= totalPages;
      }
    }

    // ==========================================
    // DRAG & DROP
    // ==========================================
    function startDrag(e) {
      e.preventDefault();
      draggedElement = e.target;
      const rect = draggedElement.getBoundingClientRect();
      const containerRect = document.getElementById('previewArea').getBoundingClientRect();
      
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;
      
      document.addEventListener('mousemove', doDrag);
      document.addEventListener('mouseup', stopDrag);
    }

    function startDragTouch(e) {
      draggedElement = e.target;
      const touch = e.touches[0];
      const rect = draggedElement.getBoundingClientRect();
      
      dragOffsetX = touch.clientX - rect.left;
      dragOffsetY = touch.clientY - rect.top;
      
      document.addEventListener('touchmove', doDragTouch, { passive: false });
      document.addEventListener('touchend', stopDrag);
    }

    function doDrag(e) {
      if (!draggedElement) return;
      e.preventDefault();
      
      const canvas = document.getElementById('pdfCanvas');
      const canvasRect = canvas.getBoundingClientRect();
      
      let x = e.clientX - canvasRect.left - dragOffsetX;
      let y = e.clientY - canvasRect.top - dragOffsetY;
      
      x = Math.max(0, Math.min(x, canvas.width - draggedElement.offsetWidth));
      y = Math.max(0, Math.min(y, canvas.height - draggedElement.offsetHeight));
      
      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
    }

    function doDragTouch(e) {
      if (!draggedElement) return;
      e.preventDefault();
      
      const touch = e.touches[0];
      const canvas = document.getElementById('pdfCanvas');
      const canvasRect = canvas.getBoundingClientRect();
      
      let x = touch.clientX - canvasRect.left - dragOffsetX;
      let y = touch.clientY - canvasRect.top - dragOffsetY;
      
      x = Math.max(0, Math.min(x, canvas.width - draggedElement.offsetWidth));
      y = Math.max(0, Math.min(y, canvas.height - draggedElement.offsetHeight));
      
      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
    }

    async function stopDrag() {
      if (draggedElement && selectedEventId && currentView === 'admin') {
        if (draggedElement.style.transform) {
          draggedElement.style.transform = '';
        }
        await savePositionToEvent();
      }
      
      draggedElement = null;
      document.removeEventListener('mousemove', doDrag);
      document.removeEventListener('mouseup', stopDrag);
      document.removeEventListener('touchmove', doDragTouch);
      document.removeEventListener('touchend', stopDrag);
    }

    async function savePositionToEvent() {
      if (!selectedEventId) return;
      
      const draggableText = document.getElementById('draggableText');
      const canvas = document.getElementById('pdfCanvas');
      
      if (!draggableText || !canvas) return;
      
      const pxX = parseFloat(draggableText.style.left) || 0;
      const pxY = parseFloat(draggableText.style.top) || 0;
      
      const ptCoords = convertPixelsToPoints(pxX, pxY, canvas.width, canvas.height);
      
      console.log('üíæ Guardando posi√ß√£o:', ptCoords);
      
      await Storage.updateEvent(selectedEventId, {
        position_x_pt: ptCoords.x,
        position_y_pt: ptCoords.y
      });
      
      showToast('Posi√ß√£o guardada!', 'success');
    }

    // ==========================================
    // ATUALIZA√á√ÉO DA POSI√á√ÉO DO DRAGGABLE
    // ==========================================
    function updateDraggablePosition(event) {
      const draggableText = document.getElementById('draggableText');
      const canvas = document.getElementById('pdfCanvas');
      
      if (!draggableText || !canvas) return;
      
      const textAlignment = event.text_alignment || 'center';
      const anchorPosition = event.anchor_position || 'center';
      
      draggableText.style.textAlign = textAlignment;
      
      const pxY = canvas.height - ((event.position_y_pt / pdfPageDimensions.height) * canvas.height);
      draggableText.style.top = pxY + 'px';
      
      if (anchorPosition === 'left') {
        const pxX = (event.position_x_pt / pdfPageDimensions.width) * canvas.width;
        draggableText.style.left = pxX + 'px';
        draggableText.style.width = 'auto';
      } else if (anchorPosition === 'center') {
        draggableText.style.left = '0px';
        draggableText.style.width = '100%';
      } else if (anchorPosition === 'right') {
        const pxX = (event.position_x_pt / pdfPageDimensions.width) * canvas.width;
        draggableText.style.right = (canvas.width - pxX) + 'px';
        draggableText.style.left = 'auto';
        draggableText.style.width = 'auto';
      }
    }

    // ==========================================
    // GERA√á√ÉO DO PDF
    // ==========================================
    async function generatePdfWithName(event, guestName) {
      try {
        console.log('üîÑ Iniciando gera√ß√£o do PDF...');
        console.log('üë§ Nome do convidado:', guestName);
        
        if (
          event.position_x_pt == null ||
          event.position_y_pt == null ||
          !event.page_number ||
          !event.pdf_path
        ) {
          throw new Error('O convite ainda n√£o foi configurado pelo administrador');
        }
        
        console.log('üìç Ponto √¢ncora:', event.position_x_pt, 'pt (X),', event.position_y_pt, 'pt (Y)');
        console.log('üìÑ P√°gina:', event.page_number);
        console.log('üé® Fonte:', event.font_size, 'pt');
        console.log('üìê Alinhamento:', event.text_alignment || 'center');
        console.log('‚öì √Çncora:', event.anchor_position || 'center');
        
        const pdfBytes = await Storage.downloadPdf(event.pdf_path);
        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        
        // ‚úÖ SEMPRE registrar fontkit ANTES de embedar fontes customizadas
        pdfDoc.registerFontkit(fontkit);
        
        let font;
        if (event.font_path) {
          try {
            console.log('üì• Baixando fonte customizada do Storage:', event.font_path);
            const fontBytes = await Storage.downloadFont(event.font_path);
            console.log('‚úÖ Fonte baixada:', fontBytes.length, 'bytes');
            
            font = await pdfDoc.embedFont(fontBytes);
            console.log('‚úÖ Fonte customizada embedada no PDF:', event.font_name);
          } catch (error) {
            console.error('‚ùå Erro ao carregar fonte customizada:', error);
            font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            console.log('‚ö†Ô∏è Fallback para Helvetica');
          }
        } else {
          font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
          console.log('‚úì Fonte padr√£o: Helvetica');
        }
        
        const pages = pdfDoc.getPages();
        const page = pages[event.page_number - 1];
        
        if (!page) {
          throw new Error('P√°gina n√£o encontrada');
        }
        
        const pageWidth = page.getWidth();
        console.log('üìê Largura da p√°gina:', pageWidth, 'pt');
        
        let displayName = guestName;
        if (event.text_transform === 'uppercase') {
          displayName = guestName.toUpperCase();
        } else if (event.text_transform === 'lowercase') {
          displayName = guestName.toLowerCase();
        } else if (event.text_transform === 'capitalize') {
          displayName = guestName.split(' ').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
          ).join(' ');
        }
        
        console.log('‚úèÔ∏è Texto final:', displayName);
        
        const rgb = hexToRgb(event.text_color);
        console.log('üé® Cor RGB:', rgb);
        
        const textWidth = font.widthOfTextAtSize(displayName, event.font_size);
        const textHeight = font.heightAtSize(event.font_size);
        const adjustedY = event.position_y_pt - textHeight;
        
        let finalX;
        
        const textAlignment = event.text_alignment || 'center';
        const anchorPosition = event.anchor_position || 'center';
        
        // CALCULA A POSI√á√ÉO X BASEADO NA √ÇNCORA
        if (anchorPosition === 'left') {
          // √Çncora √† esquerda: o ponto √¢ncora √© o in√≠cio do texto
          finalX = event.position_x_pt;
        } else if (anchorPosition === 'center') {
          // √Çncora central: o ponto √¢ncora √© o centro do texto
          finalX = event.position_x_pt - (textWidth / 2);
        } else if (anchorPosition === 'right') {
          // √Çncora √† direita: o ponto √¢ncora √© o final do texto
          finalX = event.position_x_pt - textWidth;
        }
        
        // AJUSTA BASEADO NO ALINHAMENTO (quando √¢ncora √© central)
        if (anchorPosition === 'center') {
          if (textAlignment === 'left') {
            finalX = 0;
          } else if (textAlignment === 'center') {
            finalX = (pageWidth / 2) - (textWidth / 2);
          } else if (textAlignment === 'right') {
            finalX = pageWidth - textWidth;
          } else if (textAlignment === 'justify') {
            finalX = 0;
          }
        }
        
        console.log('üìè Largura do texto:', textWidth, 'pt');
        console.log('üìê X final (in√≠cio do texto):', finalX, 'pt');
        
        page.drawText(displayName, {
          x: finalX,
          y: adjustedY,
          size: event.font_size,
          font: font,
          color: PDFLib.rgb(rgb.r, rgb.g, rgb.b)
        });
        
        console.log('üíæ Salvando PDF modificado...');
        const modifiedPdfBytes = await pdfDoc.save();
        console.log('‚úÖ PDF gerado! Tamanho:', modifiedPdfBytes.length, 'bytes');
        
        return modifiedPdfBytes;
      } catch (error) {
        console.error('‚ùå Erro ao gerar PDF:', error);
        throw error;
      }
    }

    async function downloadPdf(pdfBytes, guestName) {
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      
      // Manter acentos e espa√ßos, remover apenas caracteres especiais perigosos
      const sanitizedName = guestName
        .replace(/[<>:"/\\|?*]/g, '')
        .trim();
      
      const fileName = `${sanitizedName}.pdf`;
      
      console.log('üì• Nome do arquivo:', fileName);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      URL.revokeObjectURL(url);
    }

    // ==========================================
    // HANDLERS
    // ==========================================
    async function handleSidebarUpdate(field, value) {
      if (!selectedEventId) return;
      
      const updates = {};
      updates[field] = value;
      
      await Storage.updateEvent(selectedEventId, updates);
      
      const event = await Storage.getEvent(selectedEventId);
      
      if (field === 'font_size') {
        const draggableText = document.getElementById('draggableText');
        if (draggableText) {
          draggableText.style.fontSize = value + 'px';
        }
      }
      
      if (field === 'text_color') {
        const draggableText = document.getElementById('draggableText');
        if (draggableText) {
          draggableText.style.color = value;
        }
      }
      
      if (field === 'text_alignment' || field === 'anchor_position') {
        updateDraggablePosition(event);
      }
      
      showToast('Atualizado!', 'success');
    }

    async function handlePdfUpload(e) {
      const file = e.target.files[0];
      if (!file || !selectedEventId) return;
      
      if (file.type !== 'application/pdf') {
        showToast('Por favor, selecione um arquivo PDF', 'error');
        return;
      }
      
      const fileSizeMB = file.size / (1024 * 1024);
      console.log('üìä Tamanho do PDF:', fileSizeMB.toFixed(2), 'MB');
      
      if (fileSizeMB > 10) {
        showToast('PDF muito grande. M√°ximo: 10MB', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async function(event) {
        const arrayBuffer = event.target.result;
        const pdfBytes = new Uint8Array(arrayBuffer);
        
        try {
          // Buscar evento atual para eliminar PDF antigo
          const currentEvent = await Storage.getEvent(selectedEventId);
          
          // Eliminar PDF anterior do storage se existir
          if (currentEvent && currentEvent.pdf_path) {
            try {
              const { error: deleteError } = await supabaseClient.storage
                .from(STORAGE_BUCKET)
                .remove([currentEvent.pdf_path]);
              
              if (deleteError) {
                console.warn('‚ö†Ô∏è Erro ao eliminar PDF anterior:', deleteError);
              } else {
                console.log('‚úÖ PDF anterior eliminado');
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è Erro ao eliminar PDF anterior:', error);
            }
          }
          
          const pdfPath = await Storage.uploadPdf(selectedEventId, pdfBytes);
          
          await Storage.updateEvent(selectedEventId, { 
            pdf_path: pdfPath,
            page_number: 1,
            position_x_pt: null,
            position_y_pt: null
          });
          
          await renderPdfOnCanvas(pdfBytes, 1);
          
          showToast('PDF atualizado!', 'success');
          
          // Aguardar um pouco antes de re-renderizar
          await new Promise(resolve => setTimeout(resolve, 300));
          await render();
          
          // Re-renderizar o canvas ap√≥s o render completo
          await new Promise(resolve => setTimeout(resolve, 300));
          await renderPdfOnCanvas(pdfBytes, 1);
        } catch (error) {
          showToast(error.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function handleFontUpload(e) {
      const file = e.target.files[0];
      if (!file || !selectedEventId) return;
      
      const validTypes = ['.ttf', '.otf'];
      const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
      
      if (!validTypes.includes(fileExt)) {
        showToast('Formato inv√°lido. Use .ttf ou .otf', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async function(event) {
        const arrayBuffer = event.target.result;
        const fontBytes = new Uint8Array(arrayBuffer);
        
        try {
          // Buscar evento atual para eliminar fonte antiga
          const currentEvent = await Storage.getEvent(selectedEventId);
          
          // Eliminar fonte anterior do storage se existir
          if (currentEvent && currentEvent.font_path) {
            try {
              const { error: deleteError } = await supabaseClient.storage
                .from(STORAGE_BUCKET)
                .remove([currentEvent.font_path]);
              
              if (deleteError) {
                console.warn('‚ö†Ô∏è Erro ao eliminar fonte anterior:', deleteError);
              } else {
                console.log('‚úÖ Fonte anterior eliminada');
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è Erro ao eliminar fonte anterior:', error);
            }
          }
          
          const fontPath = await Storage.uploadFont(selectedEventId, fontBytes, file.name);
          
          await Storage.updateEvent(selectedEventId, {
            font_path: fontPath,
            font_name: file.name
          });
          
          showToast('Fonte customizada carregada!', 'success');
          
          // Re-renderizar ap√≥s troca de fonte
          await new Promise(resolve => setTimeout(resolve, 200));
          render();
        } catch (error) {
          showToast('Erro ao enviar fonte: ' + error.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function regenerateToken() {
      if (!selectedEventId) return;
      
      const newToken = generateToken();
      await Storage.updateEvent(selectedEventId, { token: newToken });
      
      showToast('Novo token gerado!', 'success');
      render();
    }

    async function toggleEventActive() {
      if (!selectedEventId) return;
      
      const event = await Storage.getEvent(selectedEventId);
      await Storage.updateEvent(selectedEventId, { active: !event.active });
      
      showToast(event.active ? 'Evento desativado' : 'Evento ativado', 'success');
      render();
    }

    // ==========================================
    // HANDLERS DE FORMUL√ÅRIOS
    // ==========================================
    async function handleTokenSubmit(e) {
      e.preventDefault();
      
      const tokenInput = document.getElementById('tokenInput');
      const token = tokenInput.value.trim();
      const rememberToken = document.getElementById('rememberToken').checked;
      
      if (!token) {
        showToast('Por favor, insira um token', 'error');
        return;
      }
      
      const event = await Storage.getEventByToken(token);
      
      if (!event) {
        showToast('Token inv√°lido ou n√£o encontrado', 'error');
        return;
      }
      
      if (!event.active) {
        showToast('Este evento est√° desativado', 'error');
        return;
      }
      
      // Salvar token se solicitado
      if (rememberToken) {
        localStorage.setItem('savedToken', token);
      } else {
        localStorage.removeItem('savedToken');
      }
      
      currentToken = token;
      currentView = 'client';
      window.history.pushState({}, '', `${window.location.pathname}?token=${token}`);
      
      subscribeToEventChanges(event.id);
      
      render();
    }
    
    async function handleCreateEvent(e) {
      e.preventDefault();
      
      if (!tempPdfBytes) {
        showToast('Por favor, fa√ßa upload do PDF', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
      
      try {
        const draggableText = document.getElementById('draggableText');
        const canvas = document.getElementById('pdfCanvas');
        
        const pxX = parseFloat(draggableText.style.left) || 0;
        const pxY = parseFloat(draggableText.style.top) || 0;
        
        const ptCoords = convertPixelsToPoints(pxX, pxY, canvas.width, canvas.height);
        
        console.log('üìù Criando evento...');
        
        const eventData = {
          event_name: document.getElementById('eventName').value,
          pdf_path: null,
          font_path: null,
          font_name: null,
          page_number: parseInt(document.getElementById('pageNumber').value),
          position_x_pt: ptCoords.x,
          position_y_pt: ptCoords.y,
          font_size: parseInt(document.getElementById('fontSize').value),
          text_color: document.getElementById('textColor').value,
          text_transform: document.getElementById('textTransform').value,
          text_alignment: document.getElementById('textAlignment').value,
          anchor_position: document.getElementById('anchorPosition').value,
          max_invites: parseInt(document.getElementById('maxInvites').value),
          token: generateToken()
        };
        
        const savedEvent = await Storage.saveEvent(eventData);
        console.log('‚úÖ Evento criado:', savedEvent.id);
        
        console.log('üì§ Enviando PDF para storage...');
        const pdfPath = await Storage.uploadPdf(savedEvent.id, tempPdfBytes);
        
        let fontPath = null;
        if (tempFontBytes && tempFontName) {
          console.log('üì§ Enviando fonte para storage...');
          fontPath = await Storage.uploadFont(savedEvent.id, tempFontBytes, tempFontName);
        }
        
        await Storage.updateEvent(savedEvent.id, {
          pdf_path: pdfPath,
          font_path: fontPath,
          font_name: tempFontName
        });
        
        console.log('‚úÖ Evento configurado completamente');
        
        selectedEventId = savedEvent.id;
        
        showToast('Evento criado com sucesso!', 'success');
        
        const pdfBytesToRender = tempPdfBytes;
        const pageToRender = parseInt(document.getElementById('pageNumber').value) || 1;
        
        tempPdfBytes = null;
        tempFontBytes = null;
        tempFontName = null;
        
        currentView = 'admin';
        await render();
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        if (pdfBytesToRender) {
          await renderPdfOnCanvas(pdfBytesToRender, pageToRender);
          
          const draggableText = document.getElementById('draggableText');
          const canvas = document.getElementById('pdfCanvas');
          
          if (draggableText && canvas) {
            const pxY = 100;
            
            draggableText.style.top = pxY + 'px';
            draggableText.style.fontSize = savedEvent.font_size + 'px';
            draggableText.style.color = savedEvent.text_color;
            
            updateDraggablePosition(savedEvent);
          }
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao criar evento:', error);
        showToast('Erro: ' + error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üé® Criar Evento';
      }
    }

    async function handleGenerateInvite(e) {
      e.preventDefault();
      
      const event = await Storage.getEventByToken(currentToken);
      if (!event) return;
      
      if (event.token !== currentToken) {
        showToast('Token inv√°lido para este evento', 'error');
        return;
      }
      
      if (!event.active) {
        showToast('Este evento est√° desativado', 'error');
        return;
      }
      
      if (
        event.position_x_pt == null ||
        event.position_y_pt == null ||
        !event.page_number ||
        !event.pdf_path
      ) {
        showToast('O convite ainda n√£o foi configurado pelo administrador', 'error');
        return;
      }
      
      const invites = await Storage.getInvites(event.id);
      
      if (invites.length >= event.max_invites) {
        showToast('Limite de convites atingido', 'error');
        return;
      }
      
      const generateBtn = document.getElementById('generateBtn');
      const guestNameInput = document.getElementById('guestName');
      const guestName = guestNameInput.value.trim();
      
      if (!guestName) {
        showToast('Digite o nome do convidado', 'error');
        return;
      }
      
      const existingInvite = await Storage.getInviteByGuestName(event.id, guestName);
      if (existingInvite) {
        showToast('J√° existe um convite para este nome', 'error');
        return;
      }
      
      generateBtn.disabled = true;
      generateBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
      
      try {
        console.log('üîÑ Gerando PDF para:', guestName);
        const pdfBytes = await generatePdfWithName(event, guestName);
        
        console.log('üì§ Guardando no banco de dados...');
        await Storage.saveInvite({
          event_id: event.id,
          guest_name: guestName
        });
        
        console.log('üì• Iniciando download...');
        await downloadPdf(pdfBytes, guestName);
        
        guestNameInput.value = '';
        showToast('‚úÖ Convite gerado e baixado!', 'success');
        
        setTimeout(() => render(), 500);
        
      } catch (error) {
        console.error('‚ùå Erro ao gerar convite:', error);
        showToast('‚ùå Erro: ' + error.message, 'error');
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'üì• Gerar Convite';
      }
    }

    async function redownloadInvite(eventId, guestName) {
      try {
        showToast('Gerando PDF...', 'success');
        
        const event = await Storage.getEvent(eventId);
        if (!event) {
          showToast('Evento n√£o encontrado', 'error');
          return;
        }
        
        console.log('üîÑ Re-gerando PDF para:', guestName);
        const pdfBytes = await generatePdfWithName(event, guestName);
        
        console.log('üì• Iniciando download...');
        await downloadPdf(pdfBytes, guestName);
        
        showToast('‚úÖ Convite baixado novamente!', 'success');
        
      } catch (error) {
        console.error('‚ùå Erro ao baixar convite:', error);
        showToast('‚ùå Erro: ' + error.message, 'error');
      }
    }

    // ==========================================
    // REALTIME SYNC
    // ==========================================
    function subscribeToEventChanges(eventId) {
      if (realtimeChannel) {
        supabaseClient.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
      
      console.log('üîÑ Inscrevendo em mudan√ßas do evento:', eventId);
      
      realtimeChannel = supabaseClient
        .channel(`event-${eventId}`)
        .on(
          'postgres_changes',
          {
            event: 'UPDATE',
            schema: 'public',
            table: 'events',
            filter: `id=eq.${eventId}`
          },
          (payload) => {
            console.log('üîî Evento atualizado em tempo real:', payload.new);
            
            if (currentView === 'client') {
              render();
            }
          }
        )
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'invites',
            filter: `event_id=eq.${eventId}`
          },
          (payload) => {
            console.log('üîî Novo convite criado:', payload.new);
            
            if (currentView === 'client') {
              render();
            }
          }
        )
        .subscribe();
    }
    
    function unsubscribeFromEventChanges() {
      if (realtimeChannel) {
        console.log('üîï Desinscrevendo de mudan√ßas');
        supabaseClient.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    // ==========================================
    // NAVEGA√á√ÉO
    // ==========================================
    function goToHome() {
      currentView = 'home';
      currentToken = null;
      unsubscribeFromEventChanges();
      window.history.pushState({}, '', window.location.pathname);
      render();
    }

    function goToAdmin() {
      if (!isAdminAuthenticated) {
        currentView = 'login';
        render();
        return;
      }
      
      currentView = 'admin';
      render();
    }

    function goToCreateEvent() {
      currentView = 'admin-create';
      tempPdfBytes = null;
      tempFontBytes = null;
      tempFontName = null;
      render();
    }

    async function selectEvent(eventId) {
      selectedEventId = eventId;
      await render();
      
      await new Promise(resolve => setTimeout(resolve, 300));
      
      const event = await Storage.getEvent(eventId);
      if (event && event.pdf_path) {
        try {
          const canvas = document.getElementById('pdfCanvas');
          if (!canvas) {
            console.error('‚ùå Canvas n√£o encontrado ap√≥s render');
            return;
          }
          
          const pdfBytes = await Storage.downloadPdf(event.pdf_path);
          await renderPdfOnCanvas(pdfBytes, event.page_number);
          
          const draggableText = document.getElementById('draggableText');
          if (draggableText && event.position_x_pt != null && event.position_y_pt != null) {
            draggableText.style.fontSize = event.font_size + 'px';
            draggableText.style.color = event.text_color;
            
            updateDraggablePosition(event);
          }
        } catch (error) {
          console.error('‚ùå Erro ao carregar PDF:', error);
          showToast('Erro ao carregar PDF: ' + error.message, 'error');
        }
      }
    }

    async function deleteEvent(eventId) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full card-shadow">
          <h3 class="text-xl font-bold mb-4">Confirmar Elimina√ß√£o</h3>
          <p class="text-gray-600 mb-6">Tem certeza que deseja eliminar este evento? Esta a√ß√£o n√£o pode ser desfeita.</p>
          <div class="flex gap-3">
            <button id="cancelDelete" class="flex-1 btn-secondary px-4 py-3 rounded-xl font-semibold">
              Cancelar
            </button>
            <button id="confirmDelete" class="flex-1 btn-danger px-4 py-3 rounded-xl font-semibold">
              Eliminar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelDelete').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('confirmDelete').onclick = async () => {
        await Storage.deleteEvent(eventId);
        if (selectedEventId === eventId) {
          selectedEventId = null;
        }
        showToast('Evento eliminado', 'success');
        document.body.removeChild(modal);
        render();
      };
    }

    function copyToken(token) {
      const url = `${window.location.origin}${window.location.pathname}?token=${token}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copiado para a √°rea de transfer√™ncia!', 'success');
      }).catch(() => {
        showToast('Erro ao copiar link', 'error');
      });
    }

    async function deleteInvite(inviteId, guestName) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full card-shadow">
          <h3 class="text-xl font-bold mb-4">Confirmar Elimina√ß√£o</h3>
          <p class="text-gray-600 mb-6">Tem certeza que deseja eliminar o convite de <strong>${guestName}</strong>?</p>
          <div class="flex gap-3">
            <button id="cancelDeleteInvite" class="flex-1 btn-secondary px-4 py-3 rounded-xl font-semibold">
              Cancelar
            </button>
            <button id="confirmDeleteInvite" class="flex-1 btn-danger px-4 py-3 rounded-xl font-semibold">
              Eliminar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelDeleteInvite').onclick = () => {
        document.body.removeChild(modal);
      };
      
      document.getElementById('confirmDeleteInvite').onclick = async () => {
        try {
          const { error } = await supabaseClient
            .from('invites')
            .delete()
            .eq('id', inviteId);
          
          if (error) throw error;
          
          showToast('Convite eliminado com sucesso', 'success');
          document.body.removeChild(modal);
          
          await render();
          
          // Re-renderizar o PDF ap√≥s eliminar convite
          if (selectedEventId) {
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const event = await Storage.getEvent(selectedEventId);
            if (event && event.pdf_path) {
              try {
                const pdfBytes = await Storage.downloadPdf(event.pdf_path);
                await renderPdfOnCanvas(pdfBytes, event.page_number);
                
                const draggableText = document.getElementById('draggableText');
                if (draggableText && event.position_x_pt != null && event.position_y_pt != null) {
                  draggableText.style.fontSize = event.font_size + 'px';
                  draggableText.style.color = event.text_color;
                  updateDraggablePosition(event);
                }
              } catch (error) {
                console.error('‚ùå Erro ao re-renderizar PDF:', error);
              }
            }
          }
        } catch (error) {
          console.error('Erro ao eliminar convite:', error);
          showToast('Erro ao eliminar convite', 'error');
          document.body.removeChild(modal);
        }
      };
    }

    // ==========================================
    // RENDERIZA√á√ÉO DAS VIEWS
    // ==========================================
    function renderHome() {
      return `
        <div class="min-h-full gradient-bg flex items-center justify-center p-4">
          <div class="bg-white rounded-3xl card-shadow p-8 max-w-md w-full">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">‚ú®</div>
              <h1 class="text-4xl font-bold text-gray-800 mb-2">
                Gerador de Convites
              </h1>
              <p class="text-gray-600">Sistema Profissional de Convites em PDF</p>
            </div>
            
            <div class="space-y-4">
              <button onclick="goToAdmin()" class="btn-primary w-full text-white font-semibold py-4 rounded-xl">
                üîê Acesso Administrador
              </button>
              
              <div class="relative py-4">
                <div class="absolute inset-0 flex items-center">
                  <div class="w-full border-t-2 border-gray-200"></div>
                </div>
                <div class="relative flex justify-center">
                  <span class="bg-white px-4 text-sm font-semibold text-gray-500">OU</span>
                </div>
              </div>
              
              <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-2xl p-6 border-2 border-cyan-100">
                <div class="text-center mb-4">
                  <p class="text-sm font-bold text-gray-700 mb-1">Tem um c√≥digo de convite?</p>
                  <p class="text-xs text-gray-600">Insira o token fornecido pelo organizador</p>
                </div>
                
                <form id="tokenForm" class="space-y-3">
                  <input type="text" id="tokenInput" required
                    class="w-full px-4 py-3 border-2 border-cyan-200 rounded-xl focus:border-cyan-500 focus:outline-none transition-colors text-center font-mono text-sm"
                    placeholder="Cole o token aqui">
                  
                  <label class="flex items-center gap-2 cursor-pointer text-left">
                    <input type="checkbox" id="rememberToken" class="w-4 h-4 rounded border-2 border-cyan-400 text-cyan-600 focus:ring-2 focus:ring-cyan-500 cursor-pointer">
                    <span class="text-xs text-gray-700">üíæ Salvar token neste dispositivo</span>
                  </label>
                  
                  <button type="submit" class="btn-secondary w-full font-semibold py-3 rounded-xl">
                    üîì Acessar Evento
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderLogin() {
      return `
        <div class="min-h-full gradient-bg flex items-center justify-center p-4">
          <div class="bg-white rounded-3xl card-shadow p-8 max-w-md w-full">
            <div class="text-center mb-8">
              <div class="text-5xl mb-4">üîí</div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">
                Login Administrativo
              </h1>
              <p class="text-gray-600">Entre com suas credenciais</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
              <div>
                <label for="loginUsername" class="block text-sm font-semibold text-gray-700 mb-2">
                  Usu√°rio
                </label>
                <input type="text" id="loginUsername" required
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors"
                  placeholder="Digite seu usu√°rio">
              </div>
              
              <div>
                <label for="loginPassword" class="block text-sm font-semibold text-gray-700 mb-2">
                  Senha
                </label>
                <input type="password" id="loginPassword" required
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors"
                  placeholder="Digite sua senha">
              </div>
              
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="rememberMe" class="w-4 h-4 rounded border-2 border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500">
                <span class="text-sm text-gray-700">Manter conectado</span>
              </label>
              
              <button type="submit" class="btn-primary w-full text-white font-bold py-4 rounded-xl">
                Entrar
              </button>
            </form>
            
            <button onclick="goToHome()" class="w-full mt-4 text-gray-500 hover:text-gray-700 font-medium">
              ‚Üê Voltar
            </button>
          </div>
        </div>
      `;
    }

    async function renderAdminSidebar() {
      const event = selectedEventId ? await Storage.getEvent(selectedEventId) : null;
      
      if (!event) {
        return `
          <div class="sidebar">
            <div class="p-6 border-b-2 border-gray-200 bg-gradient-to-r from-cyan-50 to-blue-50">
              <h2 class="text-lg font-bold text-gray-800">Configura√ß√µes</h2>
              <p class="text-sm text-gray-600 mt-1">Selecione um evento</p>
            </div>
            <div class="p-8 text-center text-gray-500">
              <div class="text-4xl mb-3">‚öôÔ∏è</div>
              <p class="text-sm">Selecione ou crie um evento para editar</p>
            </div>
          </div>
        `;
      }
      
      const invites = await Storage.getInvites(event.id);
      
      return `
        <div class="sidebar">
          <div class="p-6 border-b-2 border-gray-200 bg-gradient-to-r from-cyan-50 to-blue-50">
            <h2 class="text-lg font-bold text-gray-800">Configura√ß√µes do Evento</h2>
            <p class="text-sm text-gray-600 mt-1">${event.event_name}</p>
          </div>
          
          <div class="sidebar-item">
            <label>Nome do Evento</label>
            <input type="text" class="sidebar-input" value="${event.event_name}"
                   onchange="handleSidebarUpdate('event_name', this.value)">
          </div>
          
          <div class="sidebar-item">
            <label>PDF Base</label>
            <input type="file" accept=".pdf" class="sidebar-input" 
                   onchange="handlePdfUpload(event)">
            <p class="text-xs text-gray-500 mt-2">üìÑ ${event.pdf_path ? 'PDF carregado' : 'Nenhum PDF'}</p>
          </div>
          
          <div class="sidebar-item">
            <label>P√°gina do Nome</label>
            <input type="number" class="sidebar-input" min="1" value="${event.page_number}"
                   onchange="handleSidebarUpdate('page_number', parseInt(this.value))">
          </div>
          
          <div class="sidebar-item">
            <label>Tamanho da Fonte (pt)</label>
            <input type="number" class="sidebar-input" min="8" max="100" value="${event.font_size}"
                   onchange="handleSidebarUpdate('font_size', parseInt(this.value))">
          </div>
          
          <div class="sidebar-item">
            <label>Cor do Texto</label>
            <input type="color" class="sidebar-input" value="${event.text_color}" style="height: 50px;"
                   onchange="handleSidebarUpdate('text_color', this.value)">
          </div>
          
          <div class="sidebar-item">
            <label>Transforma√ß√£o de Texto</label>
            <select class="sidebar-input" onchange="handleSidebarUpdate('text_transform', this.value)">
              <option value="none" ${event.text_transform === 'none' ? 'selected' : ''}>Normal</option>
              <option value="uppercase" ${event.text_transform === 'uppercase' ? 'selected' : ''}>MAI√öSCULAS</option>
              <option value="lowercase" ${event.text_transform === 'lowercase' ? 'selected' : ''}>min√∫sculas</option>
              <option value="capitalize" ${event.text_transform === 'capitalize' ? 'selected' : ''}>Primeira Mai√∫scula</option>
            </select>
          </div>
          
          <div class="sidebar-item">
            <label>Alinhamento do Texto</label>
            <select class="sidebar-input" onchange="handleSidebarUpdate('text_alignment', this.value)">
              <option value="left" ${(event.text_alignment || 'center') === 'left' ? 'selected' : ''}>‚Üê Esquerda</option>
              <option value="center" ${(event.text_alignment || 'center') === 'center' ? 'selected' : ''}>‚Üî Centro</option>
              <option value="right" ${(event.text_alignment || 'center') === 'right' ? 'selected' : ''}>‚Üí Direita</option>
              <option value="justify" ${(event.text_alignment || 'center') === 'justify' ? 'selected' : ''}>‚Üî‚Üî Justificado</option>
            </select>
          </div>
          
          <div class="sidebar-item">
            <label>Tipo de √Çncora</label>
            <select class="sidebar-input" onchange="handleSidebarUpdate('anchor_position', this.value)">
              <option value="left" ${(event.anchor_position || 'center') === 'left' ? 'selected' : ''}>‚öì √Çncora √† Esquerda</option>
              <option value="center" ${(event.anchor_position || 'center') === 'center' ? 'selected' : ''}>‚öì √Çncora Central</option>
              <option value="right" ${(event.anchor_position || 'center') === 'right' ? 'selected' : ''}>‚öì √Çncora √† Direita</option>
            </select>
            <p class="text-xs text-gray-500 mt-2">Define o ponto de refer√™ncia para posicionamento</p>
          </div>
          
          <div class="sidebar-item">
            <label>M√°ximo de Convites</label>
            <input type="number" class="sidebar-input" min="1" value="${event.max_invites}"
                   onchange="handleSidebarUpdate('max_invites', parseInt(this.value))">
            <p class="text-xs text-gray-500 mt-2">üìä ${invites.length} / ${event.max_invites} gerados</p>
          </div>
          
          <div class="sidebar-item">
            <label>Fonte Customizada (.ttf/.otf)</label>
            <input type="file" accept=".ttf,.otf" class="sidebar-input" 
                   onchange="handleFontUpload(event)">
            ${event.font_name ? `
              <p class="text-xs text-green-600 mt-2">‚úì ${event.font_name}</p>
            ` : `
              <p class="text-xs text-gray-500 mt-2">Fonte padr√£o (Helvetica)</p>
            `}
          </div>
          
          <div class="sidebar-item">
            <label>Token do Cliente</label>
            <div class="token-display text-lg mb-3 text-center">
              ${event.token}
            </div>
            <button onclick="copyToken('${event.token}')" class="sidebar-btn btn-secondary mb-2">
              üìã Copiar Link
            </button>
            <button onclick="regenerateToken()" class="sidebar-btn btn-secondary">
              üîÑ Gerar Novo Token
            </button>
          </div>
          
          <div class="sidebar-item">
            <label>Status do Evento</label>
            <button onclick="toggleEventActive()" 
                    class="sidebar-btn ${event.active ? 'btn-primary text-white' : 'btn-danger'}">
              ${event.active ? '‚úì Ativo' : '‚úó Desativado'}
            </button>
          </div>
          
          <div class="sidebar-item border-t-2 border-gray-200">
            <button onclick="deleteEvent('${event.id}')" class="sidebar-btn btn-danger">
              üóëÔ∏è Eliminar Evento
            </button>
          </div>
        </div>
      `;
    }

    async function renderAdmin() {
      const events = await Storage.getEvents();
      const event = selectedEventId ? await Storage.getEvent(selectedEventId) : null;
      const invites = selectedEventId ? await Storage.getInvites(selectedEventId) : [];
      
      const sidebarHtml = await renderAdminSidebar();
      
      return `
        <div class="flex bg-gray-50 min-h-screen">
          ${sidebarHtml}
          
          <div class="main-content flex-1">
            <div class="p-6 bg-white border-b-2 border-gray-200 flex items-center justify-between sticky top-0 z-10">
              <div>
                <h1 class="text-2xl font-bold text-gray-800">Painel Administrativo</h1>
                <p class="text-sm text-gray-600 mt-1">${event ? event.event_name : 'Gerencie seus eventos e convites'}</p>
              </div>
              <div class="flex gap-3">
                <button onclick="goToCreateEvent()" class="btn-primary text-white font-semibold px-6 py-3 rounded-xl">
                  ‚ûï Criar Evento
                </button>
                <button onclick="logout()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                  Sair
                </button>
              </div>
            </div>
            
            <div class="p-6">
              ${!selectedEventId ? `
                <div>
                  <h2 class="text-xl font-bold text-gray-800 mb-4">Meus Eventos</h2>
                  <div class="grid md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                    ${events.length === 0 ? `
                      <div class="col-span-full bg-white rounded-2xl card-shadow p-12 text-center">
                        <div class="text-6xl mb-4">üìã</div>
                        <p class="text-gray-500 text-lg">Nenhum evento criado ainda</p>
                        <p class="text-gray-400 text-sm mt-2">Clique em "Criar Evento" para come√ßar</p>
                      </div>
                    ` : events.map(evt => {
                      return `
                        <div class="event-card"
                             onclick="selectEvent('${evt.id}')">
                          <div class="flex items-start justify-between mb-3">
                            <h3 class="text-lg font-bold text-gray-800 flex-1">${evt.event_name}</h3>
                            <span class="text-xs px-2 py-1 rounded-full ${evt.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                              ${evt.active ? '‚úì' : '‚úó'}
                            </span>
                          </div>
                          <div class="text-sm text-gray-600 mb-3">
                            üìÖ ${new Date(evt.created_at).toLocaleDateString('pt-PT')}
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              ` : `
                <div class="max-w-6xl">
                  <div class="bg-white rounded-2xl card-shadow p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Preview & Posicionamento</h2>
                    <p class="text-sm text-gray-600 mb-4">
                      üñ±Ô∏è Arraste o texto para posicionar o nome do convidado no PDF
                    </p>
                    
                    <div class="pdf-preview-container">
                      <div class="p-6">
                        <div class="flex items-center justify-center gap-4 mb-4">
                          <button id="prevPage" onclick="changePage(-1)" 
                                  class="px-4 py-2 bg-cyan-500 text-white rounded-lg font-semibold hover:bg-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            ‚Üê Anterior
                          </button>
                          <span id="pageInfo" class="text-sm font-semibold text-gray-700">
                            P√°gina 1 de 1
                          </span>
                          <button id="nextPage" onclick="changePage(1)" 
                                  class="px-4 py-2 bg-cyan-500 text-white rounded-lg font-semibold hover:bg-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            Seguinte ‚Üí
                          </button>
                        </div>
                        
                        <div id="previewArea" class="flex justify-center">
                          <div class="pdf-canvas-wrapper">
                            <canvas id="pdfCanvas"></canvas>
                            <div id="draggableText" class="draggable-text" 
                                 style="left: 0px; top: 100px; width: 100%; text-align: center;">
                              NOME DO CONVIDADO
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  ${invites.length > 0 ? `
                    <div class="bg-white rounded-2xl card-shadow p-6">
                      <h3 class="text-lg font-bold text-gray-800 mb-4">
                        Convites Gerados (${invites.length})
                      </h3>
                      <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${invites.map(inv => `
                          <div class="flex items-center justify-between bg-gray-50 px-4 py-3 rounded-xl border border-gray-200 hover:border-cyan-300 transition-all">
                            <div class="flex flex-col">
                              <span class="font-medium text-gray-700">${inv.guest_name}</span>
                              <span class="text-xs text-gray-500">
                                ${new Date(inv.created_at).toLocaleDateString('pt-PT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}
                              </span>
                            </div>
                            <button onclick="deleteInvite('${inv.id}', '${inv.guest_name.replace(/'/g, "\\'")}')" 
                                    class="px-3 py-2 bg-red-100 text-red-600 rounded-lg font-semibold text-sm hover:bg-red-200 transition-all">
                              üóëÔ∏è Eliminar
                            </button>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminCreate() {
      return `
        <div class="min-h-full bg-gray-50">
          <div class="max-w-4xl mx-auto p-4 md:p-8">
            <div class="bg-white rounded-2xl card-shadow p-6 md:p-8">
              <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                  Criar Novo Evento
                </h1>
                <button onclick="goToAdmin()" class="text-gray-500 hover:text-gray-700 font-medium">
                  ‚Üê Voltar
                </button>
              </div>
              
              <form id="eventForm" class="space-y-6">
                <div>
                  <label for="eventName" class="block text-sm font-semibold text-gray-700 mb-2">
                    Nome do Evento *
                  </label>
                  <input type="text" id="eventName" required 
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors"
                    placeholder="Ex: Casamento Jo√£o e Maria">
                </div>
                
                <div>
                  <label for="pdfFile" class="block text-sm font-semibold text-gray-700 mb-2">
                    PDF Base do Convite *
                  </label>
                  <input type="file" id="pdfFile" accept=".pdf" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100 transition-colors cursor-pointer">
                </div>
                
                <div>
                  <label for="fontFile" class="block text-sm font-semibold text-gray-700 mb-2">
                    Fonte Customizada (opcional)
                  </label>
                  <input type="file" id="fontFile" accept=".ttf,.otf"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100 transition-colors cursor-pointer">
                  <p class="text-xs text-gray-500 mt-2">
                    Formatos aceitos: .ttf, .otf
                  </p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label for="pageNumber" class="block text-sm font-semibold text-gray-700 mb-2">
                      P√°gina do Nome *
                    </label>
                    <input type="number" id="pageNumber" value="1" min="1" required
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors">
                  </div>
                  
                  <div>
                    <label for="fontSize" class="block text-sm font-semibold text-gray-700 mb-2">
                      Tamanho da Fonte (pt) *
                    </label>
                    <input type="number" id="fontSize" value="24" min="8" max="100" required
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors">
                  </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label for="textColor" class="block text-sm font-semibold text-gray-700 mb-2">
                      Cor do Texto *
                    </label>
                    <input type="color" id="textColor" value="#000000"
                      class="w-full h-12 border-2 border-gray-200 rounded-xl cursor-pointer">
                  </div>
                  
                  <div>
                    <label for="textTransform" class="block text-sm font-semibold text-gray-700 mb-2">
                      Transforma√ß√£o de Texto *
                    </label>
                    <select id="textTransform"
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors">
                      <option value="none">Normal</option>
                      <option value="uppercase">MAI√öSCULAS</option>
                      <option value="lowercase">min√∫sculas</option>
                      <option value="capitalize">Primeira Mai√∫scula</option>
                    </select>
                  </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label for="textAlignment" class="block text-sm font-semibold text-gray-700 mb-2">
                      Alinhamento do Texto *
                    </label>
                    <select id="textAlignment"
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors">
                      <option value="left">‚Üê Alinhado √† Esquerda</option>
                      <option value="center" selected>‚Üî Alinhado ao Centro</option>
                      <option value="right">‚Üí Alinhado √† Direita</option>
                      <option value="justify">‚Üî‚Üî Justificado</option>
                    </select>
                  </div>
                  
                  <div>
                    <label for="anchorPosition" class="block text-sm font-semibold text-gray-700 mb-2">
                      Tipo de √Çncora *
                    </label>
                    <select id="anchorPosition"
                      class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors">
                      <option value="left">‚öì √Çncora √† Esquerda</option>
                      <option value="center" selected>‚öì √Çncora Central</option>
                      <option value="right">‚öì √Çncora √† Direita</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label for="maxInvites" class="block text-sm font-semibold text-gray-700 mb-2">
                    M√°ximo de Convites *
                  </label>
                  <input type="number" id="maxInvites" value="50" min="1" max="9999" required
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors">
                </div>
                
                <div id="pdfPreview" class="pdf-preview-container hidden">
                  <div class="p-6">
                    <p class="text-sm text-gray-700 font-semibold mb-4">
                      üìç Arraste o texto para posicionar o nome do convidado:
                    </p>
                    
                    <div class="flex items-center justify-center gap-4 mb-4">
                      <button type="button" id="prevPageCreate" onclick="changePageCreate(-1)" 
                              class="px-4 py-2 bg-cyan-500 text-white rounded-lg font-semibold hover:bg-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        ‚Üê Anterior
                      </button>
                      <span id="pageInfoCreate" class="text-sm font-semibold text-gray-700">
                        P√°gina 1 de 1
                      </span>
                      <button type="button" id="nextPageCreate" onclick="changePageCreate(1)" 
                              class="px-4 py-2 bg-cyan-500 text-white rounded-lg font-semibold hover:bg-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        Seguinte ‚Üí
                      </button>
                    </div>
                    
                    <div id="previewArea" class="flex justify-center">
                      <div class="pdf-canvas-wrapper">
                        <canvas id="pdfCanvas"></canvas>
                        <div id="draggableText" class="draggable-text" 
                             style="left: 0px; top: 100px; width: 100%; text-align: center;">
                          NOME DO CONVIDADO
                        </div>
                      </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4 text-center">
                      üí° A posi√ß√£o ser√° guardada em coordenadas do PDF (pontos)
                    </p>
                  </div>
                </div>
                
                <button type="submit" id="submitBtn" 
                  class="btn-primary w-full text-white font-bold py-4 rounded-xl text-lg">
                  üé® Criar Evento
                </button>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    async function renderClient() {
      const event = await Storage.getEventByToken(currentToken);
      
      if (!event) {
        return `
          <div class="min-h-full gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl card-shadow p-8 max-w-md w-full text-center">
              <div class="text-6xl mb-4">‚ö†Ô∏è</div>
              <h2 class="text-2xl font-bold mb-4 text-red-600">Token Inv√°lido</h2>
              <p class="text-gray-600 mb-6">O link fornecido n√£o √© v√°lido ou expirou.</p>
              <button onclick="goToHome()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                Voltar ao In√≠cio
              </button>
            </div>
          </div>
        `;
      }
      
      if (!event.active) {
        return `
          <div class="min-h-full gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl card-shadow p-8 max-w-md w-full text-center">
              <div class="text-6xl mb-4">‚è∏Ô∏è</div>
              <h2 class="text-2xl font-bold mb-4 text-orange-600">Evento Desativado</h2>
              <p class="text-gray-600 mb-6">Este evento n√£o est√° mais ativo para gera√ß√£o de convites.</p>
            </div>
          </div>
        `;
      }
      
      const invites = await Storage.getInvites(event.id);
      const remainingInvites = event.max_invites - invites.length;
      const percentage = (invites.length / event.max_invites) * 100;
      
      // Carregar fonte customizada se existir
      let fontFaceStyle = '';
      if (event.font_path) {
        try {
          const { data: publicUrl } = supabaseClient.storage
            .from(STORAGE_BUCKET)
            .getPublicUrl(event.font_path);
          
          if (publicUrl && publicUrl.publicUrl) {
            const fontFormat = event.font_name.toLowerCase().endsWith('.otf') ? 'opentype' : 'truetype';
            fontFaceStyle = `
              <style>
                @font-face {
                  font-family: 'CustomEventFont';
                  src: url('${publicUrl.publicUrl}') format('${fontFormat}');
                  font-weight: normal;
                  font-style: normal;
                }
                .custom-font-text {
                  font-family: 'CustomEventFont', 'Poppins', sans-serif !important;
                }
              </style>
            `;
          }
        } catch (error) {
          console.warn('Erro ao carregar fonte customizada no cliente:', error);
        }
      }
      
      return `
        ${fontFaceStyle}
        <div class="min-h-full gradient-bg p-4">
          <div class="max-w-2xl mx-auto py-8">
            <div class="bg-white rounded-3xl card-shadow p-6 md:p-8">
              <div class="flex justify-between items-start mb-6">
                <div class="text-center flex-1">
                  <div class="text-5xl mb-3">üéâ</div>
                  <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    ${event.event_name}
                  </h1>
                  <p class="text-gray-600">
                    Gere o seu convite personalizado
                  </p>
                </div>
                <button onclick="logoutClient()" class="text-gray-500 hover:text-gray-700 font-medium text-sm">
                  ‚Üê Sair
                </button>
              </div>
              
              <div class="mb-6 p-5 rounded-2xl bg-gradient-to-r from-cyan-50 to-blue-50 border-2 border-cyan-100">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-semibold text-gray-700">Convites Gerados</span>
                  <span class="text-lg font-bold text-cyan-700">${invites.length} / ${event.max_invites}</span>
                </div>
                <div class="w-full bg-white rounded-full h-3 overflow-hidden">
                  <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-3 rounded-full transition-all duration-500" 
                       style="width: ${percentage}%"></div>
                </div>
              </div>
              
              ${remainingInvites > 0 ? `
                <form id="generateForm" class="space-y-4 mb-6">
                  <div>
                    <label for="guestName" class="block text-sm font-semibold text-gray-700 mb-2">
                      Nome do Convidado
                    </label>
                    <input type="text" id="guestName" required
                      class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-colors text-lg ${event.font_path ? 'custom-font-text' : ''}"
                      placeholder="Digite o nome completo"
                      style="${event.font_path ? `font-size: ${event.font_size}px; color: ${event.text_color};` : ''}">
                  </div>
                  
                  <button type="submit" id="generateBtn"
                    class="btn-primary w-full text-white font-bold py-4 rounded-xl text-lg">
                    üì• Gerar Convite
                  </button>
                </form>
              ` : `
                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6 mb-6 text-center">
                  <div class="text-4xl mb-3">üõë</div>
                  <p class="text-red-700 font-bold text-lg mb-1">Limite Atingido</p>
                  <p class="text-sm text-red-600">N√£o √© poss√≠vel gerar mais convites para este evento</p>
                </div>
              `}
              
              ${invites.length > 0 ? `
                <div class="border-t-2 border-gray-100 pt-6">
                  <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>üìã</span>
                    <span>Convites Gerados (${invites.length})</span>
                  </h3>
                  <div class="space-y-2 max-h-80 overflow-y-auto">
                    ${invites.map(inv => `
                      <div class="invite-item">
                        <div class="flex flex-col">
                          <span class="font-semibold text-gray-800 ${event.font_path ? 'custom-font-text' : ''}" 
                                style="${event.font_path ? `color: ${event.text_color};` : ''}">‚úì ${inv.guest_name}</span>
                          <span class="text-xs text-gray-500 mt-1">
                            ${new Date(inv.created_at).toLocaleDateString('pt-PT', { 
                              day: '2-digit', 
                              month: 'short',
                              hour: '2-digit',
                              minute: '2-digit'
                            })}
                          </span>
                        </div>
                        <button onclick="redownloadInvite('${event.id}', '${inv.guest_name.replace(/'/g, "\\'")}')" 
                                class="btn-primary text-white px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap hover:shadow-lg transition-all">
                          üì• Baixar
                        </button>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ==========================================
    // RENDERIZA√á√ÉO PRINCIPAL
    // ==========================================
    async function render() {
      const app = document.getElementById('app');
      
      let html = '';
      
      if (currentView === 'home') {
        html = renderHome();
      } else if (currentView === 'login') {
        html = renderLogin();
      } else if (currentView === 'admin') {
        html = await renderAdmin();
      } else if (currentView === 'admin-create') {
        html = renderAdminCreate();
      } else if (currentView === 'client') {
        html = await renderClient();
      }
      
      app.innerHTML = html;
      
      if (currentView === 'home') {
        attachHomeListeners();
      } else if (currentView === 'login') {
        attachLoginListeners();
      } else if (currentView === 'admin') {
        attachAdminListeners();
      } else if (currentView === 'admin-create') {
        attachCreateListeners();
      } else if (currentView === 'client') {
        attachClientListeners();
      }
    }

    function attachHomeListeners() {
      const tokenForm = document.getElementById('tokenForm');
      if (tokenForm) {
        tokenForm.addEventListener('submit', handleTokenSubmit);
      }
      
      // Preencher token salvo se existir
      const savedToken = localStorage.getItem('savedToken');
      const tokenInput = document.getElementById('tokenInput');
      const rememberTokenCheckbox = document.getElementById('rememberToken');
      
      if (savedToken && tokenInput) {
        tokenInput.value = savedToken;
        if (rememberTokenCheckbox) {
          rememberTokenCheckbox.checked = true;
        }
      }
    }
    
    function attachLoginListeners() {
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handleAdminLogin);
      }
    }

    function attachAdminListeners() {
      setTimeout(() => {
        const draggableText = document.getElementById('draggableText');
        if (draggableText) {
          draggableText.addEventListener('mousedown', startDrag);
          draggableText.addEventListener('touchstart', startDragTouch, { passive: false });
        }
      }, 100);
    }

    function attachCreateListeners() {
      const eventForm = document.getElementById('eventForm');
      if (eventForm) {
        eventForm.addEventListener('submit', handleCreateEvent);
      }
      
      const pdfFile = document.getElementById('pdfFile');
      if (pdfFile) {
        pdfFile.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          if (file.type !== 'application/pdf') {
            showToast('Por favor, selecione um arquivo PDF v√°lido', 'error');
            return;
          }
          
          const fileSizeMB = file.size / (1024 * 1024);
          console.log('üìä Tamanho do PDF:', fileSizeMB.toFixed(2), 'MB');
          
          if (fileSizeMB > 10) {
            showToast('PDF muito grande. M√°ximo: 10MB', 'error');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = async function(event) {
            try {
              const arrayBuffer = event.target.result;
              tempPdfBytes = new Uint8Array(arrayBuffer);
              
              console.log('‚úÖ PDF carregado:', tempPdfBytes.length, 'bytes');
              
              const pageNumber = parseInt(document.getElementById('pageNumber').value) || 1;
              
              const pdfDoc = await PDFLib.PDFDocument.load(tempPdfBytes);
              const totalPages = pdfDoc.getPages().length;
              
              await renderPdfOnCanvas(tempPdfBytes, pageNumber);
              
              const pageInfo = document.getElementById('pageInfoCreate');
              const prevBtn = document.getElementById('prevPageCreate');
              const nextBtn = document.getElementById('nextPageCreate');
              
              if (pageInfo) {
                pageInfo.textContent = `P√°gina ${pageNumber} de ${totalPages}`;
              }
              
              if (prevBtn) {
                prevBtn.disabled = pageNumber <= 1;
              }
              
              if (nextBtn) {
                nextBtn.disabled = pageNumber >= totalPages;
              }
              
              document.getElementById('pdfPreview').classList.remove('hidden');
              showToast('PDF carregado com sucesso!', 'success');
            } catch (error) {
              console.error('‚ùå Erro ao carregar PDF:', error);
              showToast('Erro ao carregar PDF: ' + error.message, 'error');
              tempPdfBytes = null;
            }
          };
          reader.readAsArrayBuffer(file);
        });
      }
      
      const fontFile = document.getElementById('fontFile');
      if (fontFile) {
        fontFile.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = function(event) {
            const arrayBuffer = event.target.result;
            tempFontBytes = new Uint8Array(arrayBuffer);
            tempFontName = file.name;
            showToast('Fonte carregada!', 'success');
          };
          reader.readAsArrayBuffer(file);
        });
      }
      
      const fontSize = document.getElementById('fontSize');
      if (fontSize) {
        fontSize.addEventListener('input', (e) => {
          const draggableText = document.getElementById('draggableText');
          if (draggableText) {
            draggableText.style.fontSize = e.target.value + 'px';
          }
        });
      }
      
      const textAlignment = document.getElementById('textAlignment');
      if (textAlignment) {
        textAlignment.addEventListener('change', (e) => {
          const draggableText = document.getElementById('draggableText');
          if (draggableText) {
            draggableText.style.textAlign = e.target.value;
          }
        });
      }
      
      setTimeout(() => {
        const draggableText = document.getElementById('draggableText');
        if (draggableText) {
          draggableText.addEventListener('mousedown', startDrag);
          draggableText.addEventListener('touchstart', startDragTouch, { passive: false });
        }
      }, 100);
    }

    function attachClientListeners() {
      const generateForm = document.getElementById('generateForm');
      if (generateForm) {
        generateForm.addEventListener('submit', handleGenerateInvite);
      }
    }

    // ==========================================
    // INICIALIZA√á√ÉO
    // ==========================================
    async function init() {
      // Verificar autentica√ß√£o admin (localStorage tem prioridade)
      if (localStorage.getItem('adminAuth') === 'true' || sessionStorage.getItem('adminAuth') === 'true') {
        isAdminAuthenticated = true;
      }
      
      // Verificar token na URL
      const urlParams = new URLSearchParams(window.location.search);
      let token = urlParams.get('token');
      
      // Se n√£o tem token na URL, verificar se tem salvo
      if (!token) {
        token = localStorage.getItem('savedToken');
        if (token) {
          // Verificar se o token salvo ainda √© v√°lido
          const event = await Storage.getEventByToken(token);
          if (event && event.active) {
            currentToken = token;
            currentView = 'client';
            window.history.pushState({}, '', `${window.location.pathname}?token=${token}`);
            subscribeToEventChanges(event.id);
          } else {
            // Token inv√°lido ou evento desativado, remover do storage
            localStorage.removeItem('savedToken');
          }
        }
      } else {
        // Token na URL
        currentToken = token;
        currentView = 'client';
        
        const event = await Storage.getEventByToken(token);
        if (event && event.active) {
          subscribeToEventChanges(event.id);
        }
      }
      
      render();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c284b61b32faa64',t:'MTc2OTE4MTgyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>