<!doctype html>
<html lang="pt" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    .font-display { font-family: 'Quicksand', sans-serif; }
    .font-sans { font-family: 'Quicksand', sans-serif; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.6s ease-out forwards;
    }
    
    .countdown-box {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .btn-primary {
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
    }
    
    .card-shadow {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    }
    
    .input-focus:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .radio-option {
      transition: all 0.2s ease;
    }
    
    .radio-option:hover {
      transform: scale(1.02);
    }
    
    .radio-option.selected {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full font-sans bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
  <div id="app" class="h-full w-full overflow-auto"><!-- Loading Screen -->
   <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
     <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-gray-600 font-medium">A carregar...</p>
    </div>
   </div><!-- Main Navigation / Home -->
   <div id="home-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-md mx-auto">
     <div class="text-center mb-10 animate-fade-in">
      <div class="w-20 h-20 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-lg" style="background: #007f9f;">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
       </svg>
      </div>
      <h1 id="main-title" class="font-display text-3xl md:text-4xl font-bold text-gray-800 mb-3">Confirma√ß√£o de Presen√ßa</h1>
      <p class="text-gray-500">Crie e gerencie seus eventos facilmente</p>
     </div>
     <div class="space-y-4"><button onclick="showView('register-view')" class="w-full text-white py-4 px-6 rounded-xl font-semibold text-lg btn-primary flex items-center justify-center gap-3" style="background: #007f9f;">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
       </svg> Criar Conta </button> <button onclick="showView('login-view')" class="w-full bg-white text-gray-700 py-4 px-6 rounded-xl font-semibold text-lg border-2 hover:bg-blue-50 transition-all flex items-center justify-center gap-3" style="border-color: #007f9f;">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
       </svg> Entrar </button>
     </div>
     <div class="mt-10 pt-8 border-t border-gray-200">
      <p class="text-center text-gray-500 text-sm mb-4">Procurar evento</p>
      <div class="flex gap-2"><input type="text" id="event-link-input" placeholder="Nome do evento, noivos, aniversariante..." class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus"> <button onclick="searchEvent()" class="px-6 py-3 bg-gray-800 text-white rounded-xl font-medium hover:bg-gray-700 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg></button>
      </div>
      <div id="search-results" class="mt-4 space-y-2 hidden"></div>
     </div>
    </div>
   </div><!-- Register View -->
   <div id="register-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-md mx-auto"><button onclick="showView('home-view')" class="mb-6 text-gray-500 hover:text-gray-700 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Voltar </button>
     <div class="bg-white rounded-2xl p-6 md:p-8 card-shadow">
      <h2 class="font-display text-2xl font-bold text-gray-800 mb-2">Criar Conta</h2>
      <p class="text-gray-500 mb-6">Sem e-mail necess√°rio!</p>
      <form id="register-form" class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefone ou ID √∫nico</label> <input type="text" id="reg-phone" required placeholder="Ex: 912345678" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Senha</label> <input type="password" id="reg-password" required placeholder="M  nimo 4 caracteres" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label> <input type="password" id="reg-password-confirm" required placeholder="Repita a senha" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div><button type="submit" id="register-btn" class="w-full text-white py-4 px-6 rounded-xl font-semibold text-lg btn-primary mt-6" style="background: #007f9f;"> Criar Conta </button>
      </form>
      <p id="register-error" class="hidden mt-4 text-red-500 text-sm text-center"></p>
     </div>
    </div>
   </div><!-- Login View -->
   <div id="login-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-md mx-auto"><button onclick="showView('home-view')" class="mb-6 text-gray-500 hover:text-gray-700 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Voltar </button>
     <div class="bg-white rounded-2xl p-6 md:p-8 card-shadow">
      <h2 class="font-display text-2xl font-bold text-gray-800 mb-2">Entrar</h2>
      <p class="text-gray-500 mb-6">Acesse seu painel de eventos</p>
      <form id="login-form" class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefone ou ID</label> <input type="text" id="login-phone" required placeholder="Ex: 912345678" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Senha</label> <input type="password" id="login-password" required placeholder="Sua senha" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div><button type="submit" id="login-btn" class="w-full text-white py-4 px-6 rounded-xl font-semibold text-lg btn-primary mt-6" style="background: #007f9f;"> Entrar </button>
      </form>
      <p id="login-error" class="hidden mt-4 text-red-500 text-sm text-center"></p>
     </div>
    </div>
   </div><!-- Owner Dashboard -->
   <div id="dashboard-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
     <div class="flex items-center justify-between mb-8">
      <div>
       <h2 class="font-display text-2xl font-bold text-gray-800">Meus Eventos</h2>
       <p class="text-gray-500 text-sm">Gerencie suas confirma√ß√µes</p>
      </div>
      <div class="flex items-center gap-3"><button id="back-to-admin-btn" onclick="backToAdmin()" class="hidden px-4 py-2 bg-purple-500 text-white rounded-xl font-medium hover:bg-purple-600 transition-colors flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg> Voltar ao Admin </button> <button onclick="logout()" class="text-gray-500 hover:text-red-500 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg></button>
      </div>
     </div><button onclick="showView('create-event-view')" class="w-full text-white py-4 px-6 rounded-xl font-semibold text-lg btn-primary flex items-center justify-center gap-3 mb-6" style="background: #007f9f;">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg> Criar Novo Evento </button>
     <div id="events-list" class="space-y-4"><!-- Events will be rendered here -->
     </div>
     <div id="no-events" class="hidden text-center py-12">
      <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
       <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
       </svg>
      </div>
      <p class="text-gray-500">Nenhum evento criado ainda</p>
     </div>
    </div>
   </div><!-- Create Event View -->
   <div id="create-event-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-md mx-auto"><button onclick="showView('dashboard-view')" class="mb-6 text-gray-500 hover:text-gray-700 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Voltar </button>
     <div class="bg-white rounded-2xl p-6 md:p-8 card-shadow">
      <h2 class="font-display text-2xl font-bold text-gray-800 mb-6">Criar Evento</h2>
      <form id="create-event-form" class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Imagem de Capa</label>
        <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors cursor-pointer" onclick="document.getElementById('event-cover-upload').click()">
         <div id="upload-preview" class="hidden mb-3"><img id="preview-image" src="" alt="Preview" class="max-h-48 mx-auto rounded-lg">
         </div>
         <div id="upload-placeholder">
          <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <p class="text-sm text-gray-600 mb-1">Clique para selecionar imagem</p>
          <p class="text-xs text-gray-400">PNG, JPG at√© 5MB</p>
         </div>
        </div><input type="file" id="event-cover-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">T  tulo do Evento *</label> <input type="text" id="event-title" required placeholder="Ex: Casamento Maria e Jo√£o" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Data *</label> <input type="date" id="event-date" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Hora *</label> <input type="time" id="event-time" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
        </div>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Confirmar at√© (data limite) *</label> <input type="date" id="event-confirm-by" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-3">Permitir acompanhantes?</label>
        <div class="grid grid-cols-2 gap-3"><label class="radio-option cursor-pointer border-2 border-gray-200 rounded-xl p-4 text-center block"> <input type="radio" name="allow-companions" value="yes" class="sr-only" onchange="toggleMaxCompanions()"> <span class="text-2xl mb-1 block">‚úì</span> <span class="font-medium text-gray-700">SIM</span> </label> <label class="radio-option cursor-pointer border-2 border-gray-200 rounded-xl p-4 text-center block"> <input type="radio" name="allow-companions" value="no" class="sr-only" checked onchange="toggleMaxCompanions()"> <span class="text-2xl mb-1 block">‚úó</span> <span class="font-medium text-gray-700">N√ÉO</span> </label>
        </div>
       </div>
       <div id="max-companions-field" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2">Quantos acompanhantes por convidado?</label> <input type="number" id="max-companions" min="1" max="10" value="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div><button type="submit" id="create-event-btn" class="w-full text-white py-4 px-6 rounded-xl font-semibold text-lg btn-primary mt-6" style="background: #007f9f;"> Criar Evento </button>
      </form>
     </div>
    </div>
   </div><!-- Event Details (Owner View) -->
   <div id="event-details-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-2xl mx-auto pb-16"><button onclick="showView('dashboard-view')" class="mb-6 text-gray-500 hover:text-gray-700 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Voltar aos Eventos </button>
     <div class="bg-white rounded-2xl overflow-hidden card-shadow mb-6">
      <div id="event-detail-cover" class="h-48 bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center">
       <svg class="w-16 h-16 text-white/50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
       </svg>
      </div>
      <div class="p-6">
       <h2 id="event-detail-title" class="font-display text-2xl font-bold text-gray-800 mb-2"></h2>
       <p id="event-detail-datetime" class="text-gray-500 mb-4"></p>
       <div class="bg-blue-50 rounded-xl p-4 mb-4">
        <p class="text-sm text-gray-600 mb-2">Link √∫nico do evento:</p>
        <div class="flex items-center gap-2"><code id="event-link-code" class="flex-1 bg-white px-3 py-2 rounded-lg text-xs text-blue-600 font-mono truncate"></code> <button onclick="copyEventLink()" class="px-6 py-3 text-white rounded-xl font-medium hover:opacity-90 transition-colors" style="background: #007f9f;">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg></button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Partilhe este link com os convidados</p>
       </div>
       <div class="grid grid-cols-2 gap-3"><button onclick="viewAsGuest()" class="py-3 border-2 rounded-xl font-medium hover:bg-blue-50 transition-colors flex items-center justify-center gap-2" style="border-color: #007f9f; color: #007f9f;">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
         </svg> Ver como Convidado </button> <button onclick="downloadPDF()" class="py-3 border-2 text-white rounded-xl font-medium hover:opacity-90 transition-colors flex items-center justify-center gap-2" style="background: #007f9f; border-color: #007f9f;">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg> Baixar PDF </button>
       </div><button onclick="openEditEventModal()" class="w-full mt-3 py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg> Editar Evento </button>
      </div>
     </div>
     <div class="bg-white rounded-2xl p-6 card-shadow">
      <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Confirma√ß        es</h3>
      <div id="confirmations-list" class="space-y-3"><!-- Confirmations will be rendered here -->
      </div>
      <div id="no-confirmations" class="hidden text-center py-8">
       <p class="text-gray-500">Nenhuma confirma√ß√£o ainda</p>
      </div>
      <div id="confirmations-summary" class="mt-6 pt-6 border-t border-gray-100">
       <div class="grid grid-cols-2 gap-4">
        <div class="bg-green-50 rounded-xl p-4 text-center">
         <p class="text-2xl font-bold text-green-600" id="total-yes">0</p>
         <p class="text-sm text-green-700">Confirmados</p>
        </div>
        <div class="bg-red-50 rounded-xl p-4 text-center">
         <p class="text-2xl font-bold text-red-600" id="total-no">0</p>
         <p class="text-sm text-red-700">N√£o v√£o</p>
        </div>
       </div>
      </div>
     </div>
    </div>
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-4">
     <p class="text-center text-gray-500 text-xs">   2026 AdKira. Todos os direitos reservados.</p>
    </footer>
   </div><!-- Guest Event View (Public Page) -->
   <div id="guest-event-view" class="hidden min-h-full"><!-- Back button for owner viewing as guest -->
    <div id="owner-back-button" class="hidden absolute top-4 left-4 z-50"><button onclick="backToEventDetails()" class="px-4 py-2 bg-white/90 backdrop-blur-sm text-gray-700 rounded-xl font-medium hover:bg-white transition-colors flex items-center gap-2 shadow-lg">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg> Voltar ao Painel </button>
    </div><!-- Cover Image -->
    <div id="guest-cover" class="w-full h-56 md:h-72 bg-gradient-to-br from-rose-400 via-pink-500 to-purple-600 flex items-center justify-center relative overflow-hidden">
     <div class="absolute inset-0 bg-black/20"></div>
     <svg class="w-20 h-20 text-white/30 relative z-10" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
     </svg>
    </div><!-- Countdown Timer (Guest Only) -->
    <div id="countdown-section" class="py-6 px-4 bg-white border-b border-gray-100">
     <div class="max-w-md mx-auto text-center">
      <p class="text-gray-700 text-lg font-medium mb-3">Faltam</p>
      <div class="flex justify-center gap-4">
       <div class="flex flex-col items-center"><span id="countdown-days" class="font-bold text-4xl text-gray-800">00</span> <span class="text-xs text-gray-500 mt-1">dias</span>
       </div>
       <div class="flex flex-col items-center"><span id="countdown-hours" class="font-bold text-4xl text-gray-800">00</span> <span class="text-xs text-gray-500 mt-1">horas</span>
       </div>
       <div class="flex flex-col items-center"><span id="countdown-minutes" class="font-bold text-4xl text-gray-800">00</span> <span class="text-xs text-gray-500 mt-1">min</span>
       </div>
       <div class="flex flex-col items-center"><span id="countdown-seconds" class="font-bold text-4xl text-gray-800">00</span> <span class="text-xs text-gray-500 mt-1">seg</span>
       </div>
      </div>
     </div>
    </div><!-- RSVP Form -->
    <div class="p-4 md:p-8 pb-20">
     <div class="max-w-md mx-auto">
      <div class="bg-white rounded-2xl p-6 card-shadow animate-fade-in" style="animation-delay: 0.2s">
       <div class="text-center mb-6 pb-6 border-b border-gray-100">
        <h2 id="guest-event-title" class="font-display text-xl font-semibold text-gray-800 mb-2"></h2>
        <p id="guest-event-datetime" class="text-gray-500 mb-3"></p>
        <p id="guest-confirm-by" class="text-sm italic text-gray-400"></p>
       </div>
       <form id="rsvp-form" class="space-y-5">
        <div><label class="block text-sm font-medium text-gray-700 mb-3">Confirma Presen√ßa?</label>
         <div class="flex gap-6"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="response" value="sim" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" required> <span class="text-gray-700">Sim</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="response" value="nao" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="text-gray-700">N√£o</span> </label>
         </div>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label> <input type="text" id="guest-name" required placeholder="Seu nome completo" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
        </div>
        <div id="guest-side-field"><label class="block text-sm font-medium text-gray-700 mb-3">Voc√™ √© convidado(a) do(a):</label>
         <div class="flex gap-6"><label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="guest-side" value="noivo" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" required> <span class="text-gray-700">Noivo</span> </label> <label class="flex items-center gap-2 cursor-pointer"> <input type="radio" name="guest-side" value="noiva" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="text-gray-700">Noiva</span> </label>
         </div>
        </div>
        <div id="companions-section">
         <div class="flex items-center justify-between mb-2"><label class="block text-sm font-medium text-gray-700">Acompanhantes</label> <button type="button" onclick="addCompanion()" class="text-blue-500 text-sm font-medium flex items-center gap-1 hover:text-blue-700">
           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
           </svg> Incluir </button>
         </div>
         <div id="companions-list" class="space-y-2"><!-- Companion fields will be added here -->
         </div>
        </div><button type="submit" id="rsvp-btn" class="w-full text-white py-4 px-6 rounded-xl font-semibold text-lg btn-primary" style="background: #007f9f;"> <span id="submit-text">Enviar</span> </button>
       </form>
       <p id="rsvp-success" class="hidden mt-4 text-green-600 text-center font-medium"></p>
       <p id="rsvp-error" class="hidden mt-4 text-red-500 text-center"></p>
      </div>
     </div>
    </div>
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-4">
     <p class="text-center text-gray-500 text-xs">¬© 2026 AdKira. Todos os direitos reservados.</p>
    </footer>
   </div><!-- Event Not Found -->
   <div id="event-not-found-view" class="hidden min-h-full p-4 md:p-8 flex items-center justify-center">
    <div class="text-center pb-16">
     <div class="w-20 h-20 bg-red-100 rounded-full mx-auto mb-6 flex items-center justify-center">
      <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
     </div>
     <h2 class="font-display text-2xl font-bold text-gray-800 mb-2">Evento n√£o encontrado</h2>
     <p class="text-gray-500 mb-6">O c√≥digo do evento √© inv√°lido ou foi removido</p><button onclick="showView('home-view')" class="px-6 py-3 text-white rounded-xl font-medium hover:opacity-90 transition-colors" style="background: #007f9f;"> Voltar ao in√≠cio </button>
    </div>
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-4">
     <p class="text-center text-gray-500 text-xs">¬© 2026 AdKira. Todos os direitos reservados.</p>
    </footer>
   </div><!-- Admin Dashboard -->
   <div id="admin-dashboard-view" class="hidden min-h-full p-4 md:p-8">
    <div class="max-w-4xl mx-auto pb-16">
     <div class="flex items-center justify-between mb-8">
      <div>
       <h2 class="font-display text-2xl font-bold text-gray-800">Painel Administrativo</h2>
       <p class="text-gray-500 text-sm">Gest√£o completa de contas</p>
      </div><button onclick="adminLogout()" class="text-gray-500 hover:text-red-500 transition-colors">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg></button>
     </div>
     <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
      <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Estat√≠sticas Gerais</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
       <div class="bg-blue-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-blue-600" id="admin-total-accounts">0</p>
        <p class="text-sm text-blue-700">Total Contas</p>
       </div>
       <div class="bg-green-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-green-600" id="admin-active-accounts">0</p>
        <p class="text-sm text-green-700">Ativas</p>
       </div>
       <div class="bg-red-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-red-600" id="admin-inactive-accounts">0</p>
        <p class="text-sm text-red-700">Pendentes</p>
       </div>
       <div class="bg-purple-50 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-purple-600" id="admin-total-events">0</p>
        <p class="text-sm text-purple-700">Eventos</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-2xl p-6 card-shadow">
      <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Gest√£o de Contas</h3>
      <div id="admin-accounts-list" class="space-y-3"><!-- Accounts will be rendered here -->
      </div>
      <div id="admin-no-accounts" class="hidden text-center py-8">
       <p class="text-gray-500">Nenhuma conta registada ainda</p>
      </div>
     </div>
    </div>
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-4">
     <p class="text-center text-gray-500 text-xs">¬© 2026 AdKira. Todos os direitos reservados.</p>
    </footer>
   </div><!-- Edit Confirmation Modal -->
   <div id="edit-confirmation-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full card-shadow max-h-[90vh] overflow-y-auto">
     <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Editar Confirma√ß√£o</h3>
     <form id="edit-confirmation-form" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label> <input type="text" id="edit-conf-name" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-3">Resposta</label>
       <div class="grid grid-cols-2 gap-3"><label class="radio-option cursor-pointer border-2 border-gray-200 rounded-xl p-4 text-center block"> <input type="radio" name="edit-response" value="sim" class="sr-only" required> <span class="text-2xl mb-1 block">‚úì</span> <span class="font-medium text-gray-700">SIM</span> </label> <label class="radio-option cursor-pointer border-2 border-gray-200 rounded-xl p-4 text-center block"> <input type="radio" name="edit-response" value="nao" class="sr-only"> <span class="text-2xl mb-1 block">  </span> <span class="font-medium text-gray-700">N√ÉO</span> </label>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-3">Lado</label>
       <div class="grid grid-cols-2 gap-3"><label class="radio-option cursor-pointer border-2 border-gray-200 rounded-xl p-4 text-center block"> <input type="radio" name="edit-guest-side" value="noiva" class="sr-only" required> <span class="text-2xl mb-1 block">üë∞</span> <span class="font-medium text-gray-700">Noiva</span> </label> <label class="radio-option cursor-pointer border-2 border-gray-200 rounded-xl p-4 text-center block"> <input type="radio" name="edit-guest-side" value="noivo" class="sr-only"> <span class="text-2xl mb-1 block">ü§µ</span> <span class="font-medium text-gray-700">Noivo</span> </label>
       </div>
      </div>
      <div id="edit-companions-section">
       <div class="flex items-center justify-between mb-2"><label class="block text-sm font-medium text-gray-700">Acompanhantes</label> <button type="button" onclick="addEditCompanion()" class="text-blue-500 text-sm font-medium flex items-center gap-1 hover:text-blue-700">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
         </svg> Incluir </button>
       </div>
       <div id="edit-companions-list" class="space-y-2"><!-- Companion fields will be added here -->
       </div>
      </div>
      <div class="flex gap-3 pt-4"><button type="button" onclick="closeEditConfirmationModal()" class="flex-1 py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors"> Cancelar </button> <button type="submit" id="save-confirmation-btn" class="flex-1 py-3 text-white rounded-xl font-medium hover:opacity-90 transition-colors" style="background: #007f9f;"> Guardar </button>
      </div>
     </form>
    </div>
   </div><!-- Edit Event Modal -->
   <div id="edit-event-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full card-shadow max-h-[90vh] overflow-y-auto">
     <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Editar Evento</h3>
     <form id="edit-event-form" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Imagem de Capa</label>
       <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors cursor-pointer" onclick="document.getElementById('edit-event-cover-upload').click()">
        <div id="edit-upload-preview" class="hidden mb-3"><img id="edit-preview-image" src="" alt="Preview" class="max-h-48 mx-auto rounded-lg">
        </div>
        <div id="edit-upload-placeholder">
         <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
         </svg>
         <p class="text-sm text-gray-600 mb-1">Clique para alterar imagem</p>
         <p class="text-xs text-gray-400">PNG, JPG at√© 5MB</p>
        </div>
       </div><input type="file" id="edit-event-cover-upload" accept="image/*" class="hidden" onchange="handleEditImageUpload(event)">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo do Evento *</label> <input type="text" id="edit-event-title" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
      </div>
      <div class="grid grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Data *</label> <input type="date" id="edit-event-date" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Hora *</label> <input type="time" id="edit-event-time" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Confirmar at√© (data limite) *</label> <input type="date" id="edit-event-confirm-by" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
      </div>
      <div class="flex gap-3 pt-4"><button type="button" onclick="closeEditEventModal()" class="flex-1 py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors"> Cancelar </button> <button type="submit" id="save-event-btn" class="flex-1 py-3 text-white rounded-xl font-medium hover:opacity-90 transition-colors" style="background: #007f9f;"> Guardar </button>
      </div>
     </form>
    </div>
   </div><!-- Admin Edit Account Modal -->
   <div id="admin-edit-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full card-shadow">
     <h3 class="font-display text-xl font-bold text-gray-800 mb-4">Editar Conta</h3>
     <form id="admin-edit-form" class="space-y-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Telefone/ID</label> <input type="text" id="edit-phone" readonly class="w-full px-4 py-3 border-2 border-gray-200 bg-gray-50 rounded-xl">
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Nova Senha</label> <input type="text" id="edit-password" required placeholder="Digite a nova senha" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus">
      </div>
      <div class="flex gap-3"><button type="button" onclick="closeEditModal()" class="flex-1 py-3 border-2 border-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors"> Cancelar </button> <button type="submit" id="admin-save-btn" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 transition-colors"> Guardar </button>
      </div>
     </form>
    </div>
   </div>
  </div>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://vvdbqzucsldhmsrymyab.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2ZGJxenVjc2xkaG1zcnlteWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MDc5NTksImV4cCI6MjA4NDQ4Mzk1OX0.IiBrOiUmV3fCKIfd-rsg-0CUeOmztLfg1YB93k7sJRA';
    let supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let allData = [];
    let currentOwner = null;
    let currentEvent = null;
    let currentGuestEvent = null;
    let countdownInterval = null;
    let companionCount = 0;
    let isAdmin = false;
    let currentEditAccount = null;
    let currentEditConfirmation = null;
    let editEventImageBase64 = '';

    // Admin credentials
    const ADMIN_USERNAME = 'Adkira2026';
    const ADMIN_PASSWORD = 'Adkira2026@!!Ao';

    // Supabase Helper Functions
    async function loadAllData() {
      const { data, error } = await supabaseClient
        .from('rsvp_data')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading data:', error);
        return [];
      }
      return data || [];
    }

    async function createRecord(record) {
      const { data, error } = await supabaseClient
        .from('rsvp_data')
        .insert([{ ...record, created_at: new Date().toISOString() }])
        .select();
      
      if (error) {
        console.error('Error creating record:', error);
        return { success: false, error };
      }
      return { success: true, data: data[0] };
    }

    function getOwnerEventLimit(owner) {
      return parseInt(owner.event_limit) || 0;
    }

    function canCreateMoreEvents(owner) {
      const limit = getOwnerEventLimit(owner);
      const ownerEvents = allData.filter(d => d.type === 'event' && d.owner_id === owner.owner_id);
      return ownerEvents.length < limit;
    }

    async function updateRecord(record) {
      const { data, error } = await supabaseClient
        .from('rsvp_data')
        .update(record)
        .eq('id', record.id)
        .select();
      
      if (error) {
        console.error('Error updating record:', error);
        return { success: false, error };
      }
      return { success: true, data: data[0] };
    }

    async function deleteRecord(id) {
      const { error } = await supabaseClient
        .from('rsvp_data')
        .delete()
        .eq('id', id);
      
      if (error) {
        console.error('Error deleting record:', error);
        return { success: false, error };
      }
      return { success: true };
    }

    // Config
    const defaultConfig = {
      main_title: 'Confirma√ß√£o de Presen√ßa',
      button_text: 'Enviar'
    };
    let config = { ...defaultConfig };

    // Element SDK - Initialize after DOM is ready
    function initElementSDK() {
      if (window.elementSdk) {
        try {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (newConfig) => {
              config = { ...defaultConfig, ...newConfig };
              applyConfig();
            },
            mapToCapabilities: (cfg) => ({
              recolorables: [],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (cfg) => new Map([
              ['main_title', cfg.main_title || defaultConfig.main_title],
              ['button_text', cfg.button_text || defaultConfig.button_text]
            ])
          });
        } catch (error) {
          console.error('Element SDK initialization error:', error);
        }
      }
    }
    
    // Initialize Element SDK
    initElementSDK();

    function applyConfig() {
      const mainTitle = document.getElementById('main-title');
      const submitText = document.getElementById('submit-text');
      if (mainTitle) mainTitle.textContent = config.main_title || defaultConfig.main_title;
      if (submitText) submitText.textContent = config.button_text || defaultConfig.button_text;
    }

    // Initialize
    async function init() {
      allData = await loadAllData();
      setupEventListeners();
      applyConfig();
      
      // Check for saved session
      const savedSession = localStorage.getItem('rsvp_session');
      if (savedSession) {
        try {
          const session = JSON.parse(savedSession);
          
          if (session.isAdmin) {
            isAdmin = true;
            document.getElementById('loading-screen').classList.add('hidden');
            showView('admin-dashboard-view');
            renderAdminDashboard();
            return;
          } else if (session.ownerId) {
            const owner = allData.find(d => d.type === 'owner' && d.owner_id === session.ownerId);
            if (owner && owner.account_status === 'approved') {
              currentOwner = owner;
              document.getElementById('loading-screen').classList.add('hidden');
              showView('dashboard-view');
              renderDashboard();
              return;
            } else {
              // Invalid or inactive session
              localStorage.removeItem('rsvp_session');
            }
          }
        } catch (e) {
          localStorage.removeItem('rsvp_session');
        }
      }
      
      // Check if there's an event ID in URL
      const urlParams = new URLSearchParams(window.location.search);
      const eventId = urlParams.get('event');
      
      // Hide loading
      setTimeout(() => {
        document.getElementById('loading-screen').classList.add('hidden');
        
        if (eventId) {
          // Load event directly from URL
          selectEvent(eventId);
        } else {
          showView('home-view');
        }
      }, 500);

      // Realtime subscription removed due to CSP restrictions
    }

    function setupEventListeners() {
      // Register form
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleRegister();
      });

      // Login form
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleLogin();
      });

      // Create event form
      document.getElementById('create-event-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleCreateEvent();
      });

      // RSVP form
      document.getElementById('rsvp-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleRSVP();
      });

      // Radio buttons
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const radioOption = e.target.closest('.radio-option');
          if (radioOption) {
            const parentDiv = radioOption.parentElement;
            if (parentDiv) {
              const siblings = parentDiv.querySelectorAll('.radio-option');
              siblings.forEach(opt => opt.classList.remove('selected'));
            }
            radioOption.classList.add('selected');
          }
          
          // Hide companions section if response is "n√£o"
          if (e.target.name === 'response') {
            const companionsSection = document.getElementById('companions-section');
            if (companionsSection) {
              if (e.target.value === 'nao') {
                companionsSection.classList.add('hidden');
                // Clear companions
                document.getElementById('companions-list').innerHTML = '';
              } else if (e.target.value === 'sim' && currentGuestEvent && currentGuestEvent.allow_companions === 'yes') {
                companionsSection.classList.remove('hidden');
              }
            }
          }
        });
      });

      // Search on Enter key
      document.getElementById('event-link-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchEvent();
        }
      });

      // Admin edit form
      document.getElementById('admin-edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleAdminEditAccount();
      });

      // Edit confirmation form
      document.getElementById('edit-confirmation-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleEditConfirmation();
      });

      // Edit event form
      document.getElementById('edit-event-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleEditEvent();
      });
    }

    function showView(viewId) {
      const views = ['home-view', 'register-view', 'login-view', 'dashboard-view', 
                     'create-event-view', 'event-details-view', 'guest-event-view', 'event-not-found-view',
                     'admin-dashboard-view'];
      views.forEach(v => document.getElementById(v).classList.add('hidden'));
      document.getElementById(viewId).classList.remove('hidden');
      
      if (viewId !== 'guest-event-view' && countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    function generateId() {
      return Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    function toggleMaxCompanions() {
      const allowCompanions = document.querySelector('input[name="allow-companions"]:checked').value;
      const maxField = document.getElementById('max-companions-field');
      if (allowCompanions === 'yes') {
        maxField.classList.remove('hidden');
      } else {
        maxField.classList.add('hidden');
      }
    }

    // Auth functions
    async function handleRegister() {
      const phone = document.getElementById('reg-phone').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-password-confirm').value;
      const errorEl = document.getElementById('register-error');
      const btn = document.getElementById('register-btn');

      errorEl.classList.add('hidden');

      if (password.length < 4) {
        errorEl.textContent = 'A senha deve ter no m√≠nimo 4 caracteres';
        errorEl.classList.remove('hidden');
        return;
      }

      if (password !== confirmPassword) {
        errorEl.textContent = 'As senhas n√£o coincidem';
        errorEl.classList.remove('hidden');
        return;
      }

      // Check if phone already exists
      const existingOwner = allData.find(d => d.type === 'owner' && d.owner_phone === phone);
      if (existingOwner) {
        errorEl.textContent = 'Este telefone/ID j√° est√° registado';
        errorEl.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      const result = await createRecord({
        type: 'owner',
        owner_id: generateId(),
        owner_phone: phone,
        owner_password: password,
        account_status: 'pending'
      });

      btn.disabled = false;
      btn.textContent = 'Criar Conta';

      if (result.success) {
        allData = await loadAllData();
        document.getElementById('register-form').reset();
        
        // Show pending approval message
        const successMsg = document.createElement('div');
        successMsg.className = 'mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl';
        successMsg.innerHTML = `
          <p class="text-blue-700 text-sm text-center">
            ‚úì Conta criada com sucesso!<br>
            <span class="text-xs">Aguarde aprova√ß√£o do administrador para aceder.</span>
          </p>
        `;
        document.getElementById('register-form').appendChild(successMsg);
        
        setTimeout(() => {
          showView('login-view');
        }, 3000);
      } else {
        errorEl.textContent = 'Erro ao criar conta. Tente novamente.';
        errorEl.classList.remove('hidden');
      }
    }

    async function handleLogin() {
      const phone = document.getElementById('login-phone').value.trim();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      const btn = document.getElementById('login-btn');

      errorEl.classList.add('hidden');

      // Check for admin login
      if (phone === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        isAdmin = true;
        localStorage.setItem('rsvp_session', JSON.stringify({ isAdmin: true }));
        document.getElementById('login-form').reset();
        showView('admin-dashboard-view');
        renderAdminDashboard();
        return;
      }

      const owner = allData.find(d => d.type === 'owner' && d.owner_phone === phone && d.owner_password === password);
      
      if (!owner) {
        errorEl.textContent = 'Telefone/ID ou senha incorretos';
        errorEl.classList.remove('hidden');
        return;
      }

      // Check if account is inactive
      if (owner.account_status === 'inactive') {
        errorEl.textContent = 'Conta desativada. Contacte o administrador.';
        errorEl.classList.remove('hidden');
        return;
      }

      // Check if account is pending
      if (owner.account_status === 'pending') {
        errorEl.textContent = 'Conta pendente de aprova√ß√£o. Aguarde a aprova√ß√£o do administrador.';
        errorEl.classList.remove('hidden');
        return;
      }

      currentOwner = owner;
      localStorage.setItem('rsvp_session', JSON.stringify({ ownerId: owner.owner_id }));
      document.getElementById('login-form').reset();
      showView('dashboard-view');
      renderDashboard();
    }

    function logout() {
      currentOwner = null;
      currentEvent = null;
      localStorage.removeItem('rsvp_session');
      showView('home-view');
    }

    function adminLogout() {
      isAdmin = false;
      localStorage.removeItem('rsvp_session');
      showView('home-view');
    }

    function backToAdmin() {
      currentOwner = null;
      currentEvent = null;
      localStorage.setItem('rsvp_session', JSON.stringify({ isAdmin: true }));
      showView('admin-dashboard-view');
      renderAdminDashboard();
    }

    // Image upload
    let uploadedImageBase64 = '';

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        const form = document.getElementById('create-event-form');
        const existing = form.querySelector('.upload-error');
        if (existing) existing.remove();
        const error = document.createElement('p');
        error.className = 'upload-error text-red-500 text-sm mt-2';
        error.textContent = 'Imagem muito grande. M√°ximo 5MB.';
        form.appendChild(error);
        setTimeout(() => error.remove(), 3000);
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        const form = document.getElementById('create-event-form');
        const existing = form.querySelector('.upload-error');
        if (existing) existing.remove();
        const error = document.createElement('p');
        error.className = 'upload-error text-red-500 text-sm mt-2';
        error.textContent = 'Por favor, selecione uma imagem v√°lida.';
        form.appendChild(error);
        setTimeout(() => error.remove(), 3000);
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedImageBase64 = e.target.result;
        document.getElementById('preview-image').src = uploadedImageBase64;
        document.getElementById('upload-preview').classList.remove('hidden');
        document.getElementById('upload-placeholder').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }

    // Event functions
    function renderDashboard() {
      if (!currentOwner) return;

      // Show back to admin button if in admin mode
      const savedSession = localStorage.getItem('rsvp_session');
      if (savedSession) {
        try {
          const session = JSON.parse(savedSession);
          const backBtn = document.getElementById('back-to-admin-btn');
          if (session.adminMode) {
            backBtn.classList.remove('hidden');
          } else {
            backBtn.classList.add('hidden');
          }
        } catch (e) {
          document.getElementById('back-to-admin-btn').classList.add('hidden');
        }
      }

      const ownerEvents = allData.filter(d => d.type === 'event' && d.owner_id === currentOwner.owner_id);
      const listEl = document.getElementById('events-list');
      const noEventsEl = document.getElementById('no-events');
      const createBtn = document.querySelector('[onclick="showView(\'create-event-view\')"]');
      
      // Check event limit
      const eventLimit = getOwnerEventLimit(currentOwner);
      const canCreate = canCreateMoreEvents(currentOwner);
      
      if (createBtn) {
        if (!canCreate) {
          createBtn.disabled = true;
          createBtn.classList.add('opacity-50', 'cursor-not-allowed');
          createBtn.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
            Limite de ${eventLimit} eventos atingido
          `;
        } else {
          createBtn.disabled = false;
          createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          createBtn.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Criar Novo Evento (${ownerEvents.length}/${eventLimit})
          `;
        }
      }

      if (ownerEvents.length === 0) {
        listEl.innerHTML = '';
        noEventsEl.classList.remove('hidden');
        return;
      }

      noEventsEl.classList.add('hidden');
      listEl.innerHTML = ownerEvents.map(event => {
        const confirmations = allData.filter(d => d.type === 'rsvp' && d.event_id === event.event_id);
        const yesCount = confirmations.filter(c => c.guest_response === 'sim').length;
        
        return `
          <div class="bg-white rounded-xl p-4 card-shadow cursor-pointer hover:shadow-lg transition-shadow" onclick="viewEventDetails('${event.event_id}')">
            <div class="flex items-start gap-4">
              <div class="w-16 h-16 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden" style="background: #007f9f;">
                ${event.event_cover_image ? 
                  `<img src="${event.event_cover_image}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'">` :
                  `<svg class="w-8 h-8 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>`
                }
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-800 truncate">${event.event_title}</h3>
                <p class="text-sm text-gray-500">${formatDate(event.event_date)} √†s ${event.event_time}</p>
                <p class="text-sm text-blue-500 mt-1">${yesCount} confirma√ß√µes</p>
              </div>
              <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        `;
      }).join('');
    }

    async function handleCreateEvent() {
      // Check event limit before creating
      if (!canCreateMoreEvents(currentOwner)) {
        const form = document.getElementById('create-event-form');
        const existing = form.querySelector('.limit-error');
        if (existing) existing.remove();
        const error = document.createElement('p');
        error.className = 'limit-error text-red-500 text-sm text-center mt-4';
        error.textContent = `Limite de ${getOwnerEventLimit(currentOwner)} eventos atingido. Contacte o administrador.`;
        form.appendChild(error);
        setTimeout(() => error.remove(), 5000);
        return;
      }

      const cover = uploadedImageBase64;
      const title = document.getElementById('event-title').value.trim();
      const date = document.getElementById('event-date').value;
      const time = document.getElementById('event-time').value;
      const confirmBy = document.getElementById('event-confirm-by').value;
      const allowCompanions = document.querySelector('input[name="allow-companions"]:checked').value;
      const maxCompanions = allowCompanions === 'yes' ? document.getElementById('max-companions').value : '0';
      const btn = document.getElementById('create-event-btn');

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      const eventId = generateId();
      const result = await createRecord({
        type: 'event',
        owner_id: currentOwner.owner_id,
        event_id: eventId,
        event_title: title,
        event_date: date,
        event_time: time,
        confirm_by_date: confirmBy,
        event_cover_image: cover,
        allow_companions: allowCompanions,
        max_companions: maxCompanions
      });

      btn.disabled = false;
      btn.textContent = 'Criar Evento';

      if (result.success) {
        allData = await loadAllData();
        document.getElementById('create-event-form').reset();
        uploadedImageBase64 = '';
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-placeholder').classList.remove('hidden');
        showView('dashboard-view');
        renderDashboard();
      }
    }

    function viewEventDetails(eventId) {
      const event = allData.find(d => d.type === 'event' && d.event_id === eventId);
      if (!event) return;

      currentEvent = event;
      renderEventDetails();
      showView('event-details-view');
    }

    function viewAsGuest() {
      if (!currentEvent) return;
      
      // Set current guest event to the current owner event
      currentGuestEvent = currentEvent;
      
      // Show back button since owner is viewing
      document.getElementById('owner-back-button').classList.remove('hidden');
      
      // Show guest view
      showGuestEventView();
    }

    function backToEventDetails() {
      // Hide back button
      document.getElementById('owner-back-button').classList.add('hidden');
      
      // Return to event details
      if (currentEvent) {
        renderEventDetails();
        showView('event-details-view');
      }
    }

    function renderEventDetails() {
      if (!currentEvent) return;

      const coverEl = document.getElementById('event-detail-cover');
      if (currentEvent.event_cover_image) {
        coverEl.innerHTML = `<img src="${currentEvent.event_cover_image}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<svg class=\\'w-16 h-16 text-white/50\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\\'/></svg>'">`;
      }

      document.getElementById('event-detail-title').textContent = currentEvent.event_title;
      document.getElementById('event-detail-datetime').textContent = `${formatDate(currentEvent.event_date)} √†s ${currentEvent.event_time}`;
      
      // Generate full URL
      const fullUrl = `${window.location.origin}${window.location.pathname}?event=${currentEvent.event_id}`;
      document.getElementById('event-link-code').textContent = fullUrl;

      // Render confirmations
      const confirmations = allData.filter(d => d.type === 'rsvp' && d.event_id === currentEvent.event_id);
      const listEl = document.getElementById('confirmations-list');
      const noConfEl = document.getElementById('no-confirmations');

      const yesCount = confirmations.filter(c => c.guest_response === 'sim').length;
      const noCount = confirmations.filter(c => c.guest_response === 'nao').length;

      document.getElementById('total-yes').textContent = yesCount;
      document.getElementById('total-no').textContent = noCount;

      if (confirmations.length === 0) {
        listEl.innerHTML = '';
        noConfEl.classList.remove('hidden');
        return;
      }

      noConfEl.classList.add('hidden');
      listEl.innerHTML = confirmations.map(conf => {
        const companions = conf.guest_companions ? conf.guest_companions.split(',').filter(c => c.trim()) : [];
        const isYes = conf.guest_response === 'sim';
        const side = conf.guest_side === 'noiva' ? 'üë∞' : conf.guest_side === 'noivo' ? '  ' : '';
        
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl ${isYes ? 'bg-green-50' : 'bg-red-50'}">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: ${isYes ? '#007f9f' : '#dc2626'};">
              <span class="text-white font-bold">${conf.guest_name.charAt(0).toUpperCase()}</span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-medium text-gray-800 truncate">${conf.guest_name} ${side}</p>
              ${companions.length > 0 ? `<p class="text-sm text-gray-500">+${companions.length} acompanhante(s): ${companions.join(', ')}</p>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <button onclick="editConfirmation('${conf.id}')" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg transition-colors" title="Editar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="deleteConfirmation('${conf.id}', event)" class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors" title="Eliminar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function copyEventLink() {
      if (!currentEvent) return;
      const fullUrl = `${window.location.origin}${window.location.pathname}?event=${currentEvent.event_id}`;
      navigator.clipboard.writeText(fullUrl);
      const btn = event.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span class="text-sm">‚úì Copiado!</span>';
      setTimeout(() => btn.innerHTML = originalHTML, 2000);
    }

    function editConfirmation(confirmationId) {
      const conf = allData.find(d => d.id === confirmationId);
      if (!conf) return;

      currentEditConfirmation = conf;

      // Fill form
      document.getElementById('edit-conf-name').value = conf.guest_name;
      
      // Set response radio
      const responseRadio = document.querySelector(`input[name="edit-response"][value="${conf.guest_response}"]`);
      if (responseRadio) {
        responseRadio.checked = true;
        responseRadio.closest('.radio-option').classList.add('selected');
      }

      // Set side radio
      const sideRadio = document.querySelector(`input[name="edit-guest-side"][value="${conf.guest_side}"]`);
      if (sideRadio) {
        sideRadio.checked = true;
        sideRadio.closest('.radio-option').classList.add('selected');
      }

      // Load companions
      const companionsList = document.getElementById('edit-companions-list');
      companionsList.innerHTML = '';
      
      if (conf.guest_companions) {
        const companions = conf.guest_companions.split(',').filter(c => c.trim());
        companions.forEach(companion => {
          const div = document.createElement('div');
          div.className = 'flex gap-2';
          div.innerHTML = `
            <input type="text" value="${companion}" placeholder="Nome do acompanhante" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus edit-companion-input">
            <button type="button" onclick="this.parentElement.remove()" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-xl transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          `;
          companionsList.appendChild(div);
        });
      }

      document.getElementById('edit-confirmation-modal').classList.remove('hidden');
    }

    function closeEditConfirmationModal() {
      currentEditConfirmation = null;
      document.getElementById('edit-confirmation-modal').classList.add('hidden');
      document.getElementById('edit-confirmation-form').reset();
      document.querySelectorAll('#edit-confirmation-modal .radio-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById('edit-companions-list').innerHTML = '';
    }

    function addEditCompanion() {
      if (!currentEvent || !currentEditConfirmation) return;

      if (currentEvent.allow_companions !== 'yes') return;

      const maxAllowed = parseInt(currentEvent.max_companions) || 0;
      const currentCount = document.querySelectorAll('.edit-companion-input').length;

      if (currentCount >= maxAllowed) {
        const section = document.getElementById('edit-companions-section');
        const existing = section.querySelector('.max-companions-msg');
        if (existing) existing.remove();
        const msg = document.createElement('p');
        msg.className = 'max-companions-msg text-red-500 text-sm mt-2';
        msg.textContent = `M√°ximo de ${maxAllowed} acompanhante(s) permitido`;
        section.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
        return;
      }

      const listEl = document.getElementById('edit-companions-list');
      const div = document.createElement('div');
      div.className = 'flex gap-2';
      div.innerHTML = `
        <input type="text" placeholder="Nome do acompanhante" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus edit-companion-input">
        <button type="button" onclick="this.parentElement.remove()" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-xl transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      listEl.appendChild(div);
    }

    async function handleEditConfirmation() {
      if (!currentEditConfirmation) return;

      const name = document.getElementById('edit-conf-name').value.trim();
      const response = document.querySelector('input[name="edit-response"]:checked')?.value;
      const side = document.querySelector('input[name="edit-guest-side"]:checked')?.value;
      const btn = document.getElementById('save-confirmation-btn');

      if (!name || !response || !side) {
        return;
      }

      const companions = Array.from(document.querySelectorAll('.edit-companion-input'))
        .map(input => input.value.trim())
        .filter(v => v);

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      const updatedConf = {
        ...currentEditConfirmation,
        guest_name: name,
        guest_response: response,
        guest_side: side,
        guest_companions: companions.join(',')
      };

      const result = await updateRecord(updatedConf);

      btn.disabled = false;
      btn.textContent = 'Guardar';

      if (result.success) {
        allData = await loadAllData();
        closeEditConfirmationModal();
        renderEventDetails();
      }
    }

    async function deleteConfirmation(confirmationId, clickEvent) {
      clickEvent.stopPropagation();
      const btn = clickEvent.target.closest('button');
      
      if (btn.dataset.confirm !== 'true') {
        const originalHTML = btn.innerHTML;
        btn.dataset.confirm = 'true';
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
        btn.classList.add('bg-red-500', 'text-white');
        btn.title = 'Clique novamente para confirmar';
        
        setTimeout(() => {
          if (btn.dataset.confirm === 'true') {
            btn.dataset.confirm = 'false';
            btn.innerHTML = originalHTML;
            btn.classList.remove('bg-red-500', 'text-white');
            btn.title = 'Eliminar';
          }
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';
      
      const result = await deleteRecord(confirmationId);
      
      if (result.success) {
        allData = await loadAllData();
        renderEventDetails();
      } else {
        btn.disabled = false;
        btn.dataset.confirm = 'false';
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>';
        btn.classList.remove('bg-red-500', 'text-white');
        
        const container = btn.closest('.space-y-3');
        const errorMsg = document.createElement('p');
        errorMsg.className = 'text-red-500 text-sm text-center mt-2';
        errorMsg.textContent = 'Erro ao eliminar. Tente novamente.';
        container.appendChild(errorMsg);
        setTimeout(() => errorMsg.remove(), 3000);
      }
    }

    async function deleteCurrentEvent() {
      if (!currentEvent) return;
      
      const btn = event.target.closest('button');
      if (btn.dataset.confirm !== 'true') {
        btn.dataset.confirm = 'true';
        btn.textContent = 'Clique novamente para confirmar';
        btn.classList.add('bg-red-500', 'text-white', 'border-red-500');
        setTimeout(() => {
          btn.dataset.confirm = 'false';
          btn.textContent = 'Eliminar Evento';
          btn.classList.remove('bg-red-500', 'text-white', 'border-red-500');
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      // Delete event
      await deleteRecord(currentEvent.id);

      // Delete related RSVPs
      const relatedRsvps = allData.filter(d => d.type === 'rsvp' && d.event_id === currentEvent.event_id);
      for (const rsvp of relatedRsvps) {
        await deleteRecord(rsvp.id);
      }

      allData = await loadAllData();
      currentEvent = null;
      showView('dashboard-view');
    }

    function openEditEventModal() {
      if (!currentEvent) return;

      // Fill form with current event data
      document.getElementById('edit-event-title').value = currentEvent.event_title;
      document.getElementById('edit-event-date').value = currentEvent.event_date;
      document.getElementById('edit-event-time').value = currentEvent.event_time;
      document.getElementById('edit-event-confirm-by').value = currentEvent.confirm_by_date;

      // Show current cover image if exists
      if (currentEvent.event_cover_image) {
        editEventImageBase64 = currentEvent.event_cover_image;
        document.getElementById('edit-preview-image').src = currentEvent.event_cover_image;
        document.getElementById('edit-upload-preview').classList.remove('hidden');
        document.getElementById('edit-upload-placeholder').classList.add('hidden');
      } else {
        editEventImageBase64 = '';
        document.getElementById('edit-upload-preview').classList.add('hidden');
        document.getElementById('edit-upload-placeholder').classList.remove('hidden');
      }

      document.getElementById('edit-event-modal').classList.remove('hidden');
    }

    function closeEditEventModal() {
      editEventImageBase64 = '';
      document.getElementById('edit-event-modal').classList.add('hidden');
      document.getElementById('edit-event-form').reset();
      document.getElementById('edit-upload-preview').classList.add('hidden');
      document.getElementById('edit-upload-placeholder').classList.remove('hidden');
    }

    function handleEditImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        const form = document.getElementById('edit-event-form');
        const existing = form.querySelector('.upload-error');
        if (existing) existing.remove();
        const error = document.createElement('p');
        error.className = 'upload-error text-red-500 text-sm mt-2';
        error.textContent = 'Imagem muito grande. M√°ximo 5MB.';
        form.appendChild(error);
        setTimeout(() => error.remove(), 3000);
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        const form = document.getElementById('edit-event-form');
        const existing = form.querySelector('.upload-error');
        if (existing) existing.remove();
        const error = document.createElement('p');
        error.className = 'upload-error text-red-500 text-sm mt-2';
        error.textContent = 'Por favor, selecione uma imagem v√°lida.';
        form.appendChild(error);
        setTimeout(() => error.remove(), 3000);
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        editEventImageBase64 = e.target.result;
        document.getElementById('edit-preview-image').src = editEventImageBase64;
        document.getElementById('edit-upload-preview').classList.remove('hidden');
        document.getElementById('edit-upload-placeholder').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }

    async function handleEditEvent() {
      if (!currentEvent) return;

      const title = document.getElementById('edit-event-title').value.trim();
      const date = document.getElementById('edit-event-date').value;
      const time = document.getElementById('edit-event-time').value;
      const confirmBy = document.getElementById('edit-event-confirm-by').value;
      const btn = document.getElementById('save-event-btn');

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      const updatedEvent = {
        ...currentEvent,
        event_title: title,
        event_date: date,
        event_time: time,
        confirm_by_date: confirmBy,
        event_cover_image: editEventImageBase64
      };

      const result = await updateRecord(updatedEvent);

      btn.disabled = false;
      btn.textContent = 'Guardar';

      if (result.success) {
        allData = await loadAllData();
        currentEvent = updatedEvent;
        closeEditEventModal();
        renderEventDetails();
        renderDashboard();
      }
    }

    // PDF Download
    function downloadPDF() {
      if (!currentEvent) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const allRsvps = allData.filter(d => d.type === 'rsvp' && d.event_id === currentEvent.event_id);
      const confirmations = allRsvps.filter(r => r.guest_response === 'sim');
      const notComing = allRsvps.filter(r => r.guest_response === 'nao');

      // Title
      doc.setFontSize(18);
      doc.text(currentEvent.event_title, 105, 20, { align: 'center' });

      // Event details
      doc.setFontSize(12);
      doc.text(`Data: ${formatDate(currentEvent.event_date)} √†s ${currentEvent.event_time}`, 105, 30, { align: 'center' });

      // Summary
      doc.setFontSize(14);
      doc.text(`Total de Confirma√ß√µes: ${confirmations.length}`, 20, 45);
      doc.text(`N√£o Comparecem: ${notComing.length}`, 20, 53);

      // Separate by side - YES responses
      const noivaYes = confirmations.filter(c => c.guest_side === 'noiva');
      const noivoYes = confirmations.filter(c => c.guest_side === 'noivo');

      let yPos = 68;

      // Section: CONFIRMARAM PRESEN√áA
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text('CONFIRMARAM PRESEN√áA', 20, yPos);
      yPos += 10;

      // Noiva guests - YES
      if (noivaYes.length > 0) {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Convidados da Noiva:', 20, yPos);
        yPos += 8;
        doc.setFont(undefined, 'normal');

        noivaYes.forEach(conf => {
          const companions = conf.guest_companions ? conf.guest_companions.split(',').filter(c => c.trim()) : [];
          let line = `${conf.guest_name}`;
          
          if (companions.length > 0) {
            line += ` e ${companions.join(', ')}`;
          }

          doc.setFontSize(10);
          const splitText = doc.splitTextToSize(line, 170);
          doc.text(splitText, 25, yPos);
          yPos += splitText.length * 5 + 3;

          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
        });

        yPos += 5;
      }

      // Noivo guests - YES
      if (noivoYes.length > 0) {
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }

        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Convidados do Noivo:', 20, yPos);
        yPos += 8;
        doc.setFont(undefined, 'normal');

        noivoYes.forEach(conf => {
          const companions = conf.guest_companions ? conf.guest_companions.split(',').filter(c => c.trim()) : [];
          let line = `${conf.guest_name}`;
          
          if (companions.length > 0) {
            line += ` e ${companions.join(', ')}`;
          }

          doc.setFontSize(10);
          const splitText = doc.splitTextToSize(line, 170);
          doc.text(splitText, 25, yPos);
          yPos += splitText.length * 5 + 3;

          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
        });

        yPos += 10;
      }

      // Section: N√ÉO COMPARECEM
      if (notComing.length > 0) {
        if (yPos > 240) {
          doc.addPage();
          yPos = 20;
        }

        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('N√ÉO COMPARECEM', 20, yPos);
        yPos += 10;

        const noivaNo = notComing.filter(c => c.guest_side === 'noiva');
        const noivoNo = notComing.filter(c => c.guest_side === 'noivo');

        // Noiva guests - NO
        if (noivaNo.length > 0) {
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('Convidados da Noiva:', 20, yPos);
          yPos += 8;
          doc.setFont(undefined, 'normal');

          noivaNo.forEach(conf => {
            doc.setFontSize(10);
            const splitText = doc.splitTextToSize(conf.guest_name, 170);
            doc.text(splitText, 25, yPos);
            yPos += splitText.length * 5 + 3;

            if (yPos > 270) {
              doc.addPage();
              yPos = 20;
            }
          });

          yPos += 5;
        }

        // Noivo guests - NO
        if (noivoNo.length > 0) {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }

          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('Convidados do Noivo:', 20, yPos);
          yPos += 8;
          doc.setFont(undefined, 'normal');

          noivoNo.forEach(conf => {
            doc.setFontSize(10);
            const splitText = doc.splitTextToSize(conf.guest_name, 170);
            doc.text(splitText, 25, yPos);
            yPos += splitText.length * 5 + 3;

            if (yPos > 270) {
              doc.addPage();
              yPos = 20;
            }
          });
        }
      }

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Gerado por AdKira RSVP - P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
      }

      doc.save(`${currentEvent.event_title.replace(/\s+/g, '_')}_confirmacoes.pdf`);
    }

    // Guest functions
    function searchEvent() {
      const searchTerm = document.getElementById('event-link-input').value.trim().toLowerCase();
      const resultsEl = document.getElementById('search-results');
      
      if (!searchTerm) {
        resultsEl.classList.add('hidden');
        return;
      }
      
      // Search by event title or event ID
      const events = allData.filter(d => 
        d.type === 'event' && 
        (d.event_title.toLowerCase().includes(searchTerm) || 
         d.event_id.toLowerCase().includes(searchTerm))
      );
      
      if (events.length === 0) {
        resultsEl.innerHTML = `
          <div class="text-center py-4 px-4 bg-gray-50 rounded-xl">
            <p class="text-gray-500 text-sm">Nenhum evento encontrado</p>
          </div>
        `;
        resultsEl.classList.remove('hidden');
        return;
      }
      
      resultsEl.innerHTML = events.map(event => `
        <div class="bg-white rounded-xl p-4 border-2 border-gray-100 hover:border-blue-300 cursor-pointer transition-colors" onclick="selectEvent('${event.event_id}')">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden" style="background: #007f9f;">
              ${event.event_cover_image ? 
                `<img src="${event.event_cover_image}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'">` :
                `<svg class="w-6 h-6 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>`
              }
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-semibold text-gray-800 truncate">${event.event_title}</p>
              <p class="text-xs text-gray-500">${formatDate(event.event_date)} √†s ${event.event_time}</p>
            </div>
            <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </div>
      `).join('');
      
      resultsEl.classList.remove('hidden');
    }
    
    function selectEvent(eventId) {
      const event = allData.find(d => d.type === 'event' && d.event_id === eventId);
      if (!event) {
        showView('event-not-found-view');
        return;
      }

      currentGuestEvent = event;
      document.getElementById('event-link-input').value = '';
      document.getElementById('search-results').classList.add('hidden');
      showGuestEventView();
    }

    function showGuestEventView() {
      if (!currentGuestEvent) return;

      // Hide back button for public guests (only shown when owner views as guest)
      if (!currentOwner) {
        document.getElementById('owner-back-button').classList.add('hidden');
      }

      // Set cover
      const coverEl = document.getElementById('guest-cover');
      if (currentGuestEvent.event_cover_image) {
        coverEl.innerHTML = `
          <div class="absolute inset-0 bg-black/20"></div>
          <img src="${currentGuestEvent.event_cover_image}" alt="" class="absolute inset-0 w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'">
        `;
      } else {
        coverEl.innerHTML = `
          <div class="absolute inset-0 bg-black/20"></div>
          <svg class="w-20 h-20 text-white/30 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        `;
      }

      // Set event details
      document.getElementById('guest-event-title').textContent = currentGuestEvent.event_title;
      document.getElementById('guest-event-datetime').textContent = `${formatDate(currentGuestEvent.event_date)} √†s ${currentGuestEvent.event_time}`;
      document.getElementById('guest-confirm-by').textContent = `Favor confirmar at√© ${formatDate(currentGuestEvent.confirm_by_date)}`;

      // Check if deadline has passed or event has already happened
      const confirmByDate = new Date(currentGuestEvent.confirm_by_date);
      confirmByDate.setHours(23, 59, 59, 999);
      const eventDateTime = new Date(`${currentGuestEvent.event_date}T${currentGuestEvent.event_time}`);
      const now = new Date();
      
      const formEl = document.getElementById('rsvp-form');
      const errorEl = document.getElementById('rsvp-error');
      
      if (now > eventDateTime) {
        // Event already happened
        formEl.classList.add('hidden');
        errorEl.innerHTML = '<p class="text-center text-gray-600 font-medium">Este evento j√° foi realizado.</p>';
        errorEl.classList.remove('hidden');
      } else if (now > confirmByDate) {
        // Deadline passed
        formEl.classList.add('hidden');
        errorEl.innerHTML = '<p class="text-center text-gray-600 font-medium">O per√≠odo de confirma√ß√£o terminou.</p>';
        errorEl.classList.remove('hidden');
      } else {
        // Form is active
        formEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        
        // Reset form
        document.getElementById('rsvp-form').reset();
        document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('companions-list').innerHTML = '';
        companionCount = 0;
        document.getElementById('rsvp-success').classList.add('hidden');

        // Show or hide companions section based on event settings
        const companionsSection = document.getElementById('companions-section');
        if (currentGuestEvent.allow_companions === 'yes') {
          companionsSection.classList.remove('hidden');
        } else {
          companionsSection.classList.add('hidden');
        }
      }

      // Start countdown
      startCountdown();

      showView('guest-event-view');
    }

    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);

      function updateCountdown() {
        if (!currentGuestEvent) return;

        const eventDate = new Date(`${currentGuestEvent.event_date}T${currentGuestEvent.event_time}`);
        const now = new Date();
        const diff = eventDate - now;

        if (diff <= 0) {
          document.getElementById('countdown-days').textContent = '00';
          document.getElementById('countdown-hours').textContent = '00';
          document.getElementById('countdown-minutes').textContent = '00';
          document.getElementById('countdown-seconds').textContent = '00';
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        document.getElementById('countdown-days').textContent = String(days).padStart(2, '0');
        document.getElementById('countdown-hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('countdown-minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('countdown-seconds').textContent = String(seconds).padStart(2, '0');
      }

      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function addCompanion() {
      if (!currentGuestEvent) return;

      // Check if companions are allowed
      if (currentGuestEvent.allow_companions !== 'yes') return;

      const maxAllowed = parseInt(currentGuestEvent.max_companions) || 0;
      const currentCount = document.querySelectorAll('.companion-input').length;

      if (currentCount >= maxAllowed) {
        const section = document.getElementById('companions-section');
        const existing = section.querySelector('.max-companions-msg');
        if (existing) existing.remove();
        const msg = document.createElement('p');
        msg.className = 'max-companions-msg text-red-500 text-sm mt-2';
        msg.textContent = `M√°ximo de ${maxAllowed} acompanhante(s) permitido`;
        section.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
        return;
      }

      companionCount++;
      const listEl = document.getElementById('companions-list');
      const div = document.createElement('div');
      div.className = 'flex gap-2';
      div.innerHTML = `
        <input type="text" placeholder="Nome do acompanhante" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus companion-input">
        <button type="button" onclick="this.parentElement.remove()" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-xl transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      listEl.appendChild(div);
    }

    function showAlreadyConfirmedState(rsvp) {
      const successEl = document.getElementById('rsvp-success');
      const formEl = document.getElementById('rsvp-form');
      
      // Hide form
      formEl.classList.add('hidden');
      
      // Show success with edit button
      successEl.innerHTML = `
        <p class="text-green-600 font-medium mb-3">‚úì Confirma√ß√£o feita com sucesso</p>
        <button onclick="editGuestResponse('${rsvp.id}')" class="w-full py-3 px-6 border-2 rounded-xl font-medium hover:bg-blue-50 transition-colors" style="border-color: #007f9f; color: #007f9f;">
          Editar resposta
        </button>
      `;
      successEl.classList.remove('hidden');
      
      // Scroll to success message
      successEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function editGuestResponse(rsvpId) {
      const rsvp = allData.find(d => d.id === rsvpId);
      if (!rsvp) return;
      
      const formEl = document.getElementById('rsvp-form');
      const successEl = document.getElementById('rsvp-success');
      
      // Hide success message
      successEl.classList.add('hidden');
      
      // Show form
      formEl.classList.remove('hidden');
      
      // Fill form with existing data
      document.getElementById('guest-name').value = rsvp.guest_name;
      
      // Set response radio
      const responseRadio = document.querySelector(`input[name="response"][value="${rsvp.guest_response}"]`);
      if (responseRadio) {
        responseRadio.checked = true;
        const radioOption = responseRadio.closest('.radio-option');
        if (radioOption) {
          radioOption.parentElement.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
          radioOption.classList.add('selected');
        }
      }
      
      // Set side radio
      const sideRadio = document.querySelector(`input[name="guest-side"][value="${rsvp.guest_side}"]`);
      if (sideRadio) {
        sideRadio.checked = true;
        const radioOption = sideRadio.closest('.radio-option');
        if (radioOption) {
          radioOption.parentElement.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
          radioOption.classList.add('selected');
        }
      }
      
      // Load companions
      const companionsList = document.getElementById('companions-list');
      companionsList.innerHTML = '';
      
      if (rsvp.guest_companions) {
        const companions = rsvp.guest_companions.split(',').filter(c => c.trim());
        companions.forEach(companion => {
          const div = document.createElement('div');
          div.className = 'flex gap-2';
          div.innerHTML = `
            <input type="text" value="${companion}" placeholder="Nome do acompanhante" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none input-focus companion-input">
            <button type="button" onclick="this.parentElement.remove()" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-xl transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          `;
          companionsList.appendChild(div);
        });
      }
      
      // Mark form as editing
      formEl.dataset.editingRsvpId = rsvpId;
      
      // Scroll to form
      formEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    async function handleRSVP() {
      if (!currentGuestEvent) return;

      const response = document.querySelector('input[name="response"]:checked')?.value;
      const name = document.getElementById('guest-name').value.trim();
      const guestSide = document.querySelector('input[name="guest-side"]:checked')?.value || '';
      const successEl = document.getElementById('rsvp-success');
      const errorEl = document.getElementById('rsvp-error');
      const btn = document.getElementById('rsvp-btn');

      successEl.classList.add('hidden');
      errorEl.classList.add('hidden');

      // Check if deadline has passed
      const confirmByDate = new Date(currentGuestEvent.confirm_by_date);
      confirmByDate.setHours(23, 59, 59, 999);
      const now = new Date();
      
      if (now > confirmByDate) {
        errorEl.textContent = 'Prazo de confirma√ß√£o encerrado';
        errorEl.classList.remove('hidden');
        return;
      }

      // Check if event has already happened
      const eventDateTime = new Date(`${currentGuestEvent.event_date}T${currentGuestEvent.event_time}`);
      if (now > eventDateTime) {
        errorEl.textContent = 'Este evento j√° foi realizado';
        errorEl.classList.remove('hidden');
        return;
      }

      if (!response) {
        errorEl.textContent = 'Por favor, selecione SIM ou N√ÉO';
        errorEl.classList.remove('hidden');
        return;
      }

      if (!name) {
        errorEl.textContent = 'Por favor, informe seu nome';
        errorEl.classList.remove('hidden');
        return;
      }

      if (!guestSide) {
        errorEl.textContent = 'Por favor, informe se    convidado da noiva ou do noivo';
        errorEl.classList.remove('hidden');
        return;
      }

      // Get companions
      const companions = Array.from(document.querySelectorAll('.companion-input'))
        .map(input => input.value.trim())
        .filter(v => v);

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      // Check if we are editing an existing RSVP
      const rsvpForm = document.getElementById('rsvp-form');
      const editingRsvpId = rsvpForm.dataset.editingRsvpId;
      let result;

      if (editingRsvpId) {
        // Update existing RSVP
        const existingRsvp = allData.find(d => d.id === editingRsvpId);
        if (existingRsvp) {
          result = await updateRecord({
            ...existingRsvp,
            guest_name: name,
            guest_response: response,
            guest_companions: companions.join(','),
            guest_side: guestSide
          });
        }
        delete rsvpForm.dataset.editingRsvpId;
      } else {
        // Check if guest already has an RSVP (by name and event)
        const existingRsvp = allData.find(d => 
          d.type === 'rsvp' && 
          d.event_id === currentGuestEvent.event_id && 
          d.guest_name.toLowerCase() === name.toLowerCase()
        );

        if (existingRsvp) {
          // Update existing record
          result = await updateRecord({
            ...existingRsvp,
            guest_name: name,
            guest_response: response,
            guest_companions: companions.join(','),
            guest_side: guestSide
          });
        } else {
          // Create new record
          result = await createRecord({
            type: 'rsvp',
            event_id: currentGuestEvent.event_id,
            guest_name: name,
            guest_response: response,
            guest_companions: companions.join(','),
            guest_side: guestSide
          });
        }
      }

      btn.disabled = false;
      btn.innerHTML = `<span id="submit-text">${config.button_text || defaultConfig.button_text}</span>`;

      if (result.success) {
        allData = await loadAllData();
        
        // Get the updated/created RSVP
        const savedRsvp = result.data;
        
        // Save to localStorage for persistence
        const guestSessionKey = `guest_rsvp_${currentGuestEvent.event_id}`;
        localStorage.setItem(guestSessionKey, JSON.stringify({
          rsvpId: savedRsvp.id,
          eventId: currentGuestEvent.event_id
        }));
        
        // Show confirmation state
        showAlreadyConfirmedState(savedRsvp);
        
        // Reset form
        document.getElementById('rsvp-form').reset();
        document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
        document.getElementById('companions-list').innerHTML = '';
      } else {
        errorEl.textContent = 'Erro ao enviar. Tente novamente.';
        errorEl.classList.remove('hidden');
      }
    }

    // Admin functions
    function renderAdminDashboard() {
      if (!isAdmin) return;

      const owners = allData.filter(d => d.type === 'owner');
      const events = allData.filter(d => d.type === 'event');
      const activeOwners = owners.filter(o => o.account_status === 'approved');
      const inactiveOwners = owners.filter(o => o.account_status === 'inactive');
      const pendingOwners = owners.filter(o => o.account_status === 'pending');

      // Update stats
      document.getElementById('admin-total-accounts').textContent = owners.length;
      document.getElementById('admin-active-accounts').textContent = activeOwners.length;
      document.getElementById('admin-inactive-accounts').textContent = pendingOwners.length;
      document.getElementById('admin-total-events').textContent = events.length;

      // Render accounts list
      const listEl = document.getElementById('admin-accounts-list');
      const noAccountsEl = document.getElementById('admin-no-accounts');

      if (owners.length === 0) {
        listEl.innerHTML = '';
        noAccountsEl.classList.remove('hidden');
        return;
      }

      noAccountsEl.classList.add('hidden');
      
      // Sort: pending first, then approved, then inactive
      const sortedOwners = [
        ...pendingOwners,
        ...activeOwners,
        ...inactiveOwners
      ];
      
      listEl.innerHTML = sortedOwners.map(owner => {
        const status = owner.account_status || 'pending';
        const statusColors = {
          approved: { border: 'border-green-200', bg: 'bg-green-50/50', badge: 'bg-green-100 text-green-700', text: 'Aprovada' },
          pending: { border: 'border-yellow-200', bg: 'bg-yellow-50/50', badge: 'bg-yellow-100 text-yellow-700', text: 'Pendente' },
          inactive: { border: 'border-red-200', bg: 'bg-red-50/50', badge: 'bg-red-100 text-red-700', text: 'Inativa' }
        };
        const colors = statusColors[status] || statusColors.pending;
        const ownerEvents = events.filter(e => e.owner_id === owner.owner_id);
        const eventLimit = getOwnerEventLimit(owner);
        
        return `
          <div class="border-2 ${colors.border} ${colors.bg} rounded-xl p-4">
            <div class="flex items-start justify-between gap-4 mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h4 class="font-semibold text-gray-800">${owner.owner_phone}</h4>
                  <span class="px-2 py-1 text-xs font-medium rounded-full ${colors.badge}">
                    ${colors.text}
                  </span>
                </div>
                <p class="text-sm text-gray-600">ID: ${owner.owner_id}</p>
                <p class="text-sm text-gray-500 mt-1">Senha: ${status === 'inactive' ? '***INATIVA***' : owner.owner_password}</p>
                <p class="text-sm text-blue-500 mt-1">${ownerEvents.length} evento(s) criado(s)</p>
                <p class="text-sm text-purple-600 font-medium mt-1">Limite: ${eventLimit} eventos</p>
              </div>
            </div>
            
            ${status !== 'pending' ? `
              <div class="mb-3 flex gap-2">
                <input type="number" id="limit-${owner.id}" min="0" max="50" value="${eventLimit}" placeholder="Limite" class="flex-1 px-3 py-2 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-400">
                <button onclick="updateEventLimit('${owner.id}')" class="px-4 py-2 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600 transition-colors">
                  Atualizar
                </button>
              </div>
            ` : ''}
            
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                ${status === 'pending' ? `
                  <button onclick="approveAccount('${owner.id}')" class="flex-1 py-2 px-3 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                    Aprovar
                  </button>
                  <button onclick="rejectAccount('${owner.id}')" class="flex-1 py-2 px-3 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
                    Rejeitar
                  </button>
                ` : `
                  <button onclick="openEditModal('${owner.id}')" class="flex-1 py-2 px-3 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                    Trocar Senha
                  </button>
                  <button onclick="toggleAccountStatus('${owner.id}')" class="flex-1 py-2 px-3 ${status === 'approved' ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg text-sm font-medium transition-colors">
                    ${status === 'approved' ? 'Desativar' : 'Ativar'}
                  </button>
                `}
              </div>
              <div class="flex gap-2">
                <button onclick="adminLoginAsUser('${owner.id}')" class="flex-1 py-2 px-3 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600 transition-colors">
                  Entrar como Usu√°rio
                </button>
                <button onclick="adminDeleteAccount('${owner.id}')" class="flex-1 py-2 px-3 bg-gray-700 text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors">
                  Eliminar Conta
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openEditModal(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      currentEditAccount = owner;
      document.getElementById('edit-phone').value = owner.owner_phone;
      document.getElementById('edit-password').value = '';
      document.getElementById('admin-edit-modal').classList.remove('hidden');
    }

    function closeEditModal() {
      currentEditAccount = null;
      document.getElementById('admin-edit-modal').classList.add('hidden');
      document.getElementById('admin-edit-form').reset();
    }

    async function handleAdminEditAccount() {
      if (!currentEditAccount) return;

      const newPassword = document.getElementById('edit-password').value.trim();
      const btn = document.getElementById('admin-save-btn');

      if (!newPassword || newPassword.length < 4) {
        const form = document.getElementById('admin-edit-form');
        const existing = form.querySelector('.error-msg');
        if (existing) existing.remove();
        const error = document.createElement('p');
        error.className = 'error-msg text-red-500 text-sm text-center mt-2';
        error.textContent = 'Senha deve ter no m  nimo 4 caracteres';
        form.appendChild(error);
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      const updatedOwner = { ...currentEditAccount, owner_password: newPassword };
      const result = await updateRecord(updatedOwner);

      btn.disabled = false;
      btn.textContent = 'Guardar';

      if (result.success) {
        allData = await loadAllData();
        closeEditModal();
      }
    }

    async function toggleAccountStatus(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      const status = owner.account_status || 'pending';
      const newStatus = status === 'approved' ? 'inactive' : 'approved';

      const updatedOwner = { ...owner, account_status: newStatus };
      await updateRecord(updatedOwner);
      allData = await loadAllData();
    }

    async function approveAccount(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      const updatedOwner = { ...owner, account_status: 'approved', event_limit: 1 };
      await updateRecord(updatedOwner);
      allData = await loadAllData();
      renderAdminDashboard();
    }

    async function rejectAccount(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      await deleteRecord(owner.id);
      allData = await loadAllData();
      renderAdminDashboard();
    }

    async function updateEventLimit(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      const input = document.getElementById(`limit-${backendId}`);
      const newLimit = parseInt(input.value) || 0;

      if (newLimit < 0 || newLimit > 50) {
        const container = input.parentElement;
        const existing = container.querySelector('.limit-msg');
        if (existing) existing.remove();
        const msg = document.createElement('p');
        msg.className = 'limit-msg text-red-500 text-xs mt-1';
        msg.textContent = 'Limite deve estar entre 0 e 50';
        container.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
        return;
      }

      const updatedOwner = { ...owner, event_limit: newLimit };
      await updateRecord(updatedOwner);
      allData = await loadAllData();
      
      // Show success message
      const container = input.parentElement;
      const existing = container.querySelector('.limit-msg');
      if (existing) existing.remove();
      const msg = document.createElement('p');
      msg.className = 'limit-msg text-green-600 text-xs mt-1';
      msg.textContent = '‚úì Limite atualizado';
      container.appendChild(msg);
      setTimeout(() => {
        msg.remove();
        renderAdminDashboard();
      }, 2000);
    }

    async function adminDeleteAccount(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      const btn = event.target;
      
      if (btn.dataset.confirm !== 'true') {
        btn.dataset.confirm = 'true';
        btn.textContent = 'Confirmar Elimina√ß√£o';
        btn.classList.add('bg-red-600');
        setTimeout(() => {
          btn.dataset.confirm = 'false';
          btn.textContent = 'Eliminar Conta';
          btn.classList.remove('bg-red-600');
        }, 3000);
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';

      // Delete owner account
      await deleteRecord(owner.id);

      // Delete all events created by this owner
      const ownerEvents = allData.filter(d => d.type === 'event' && d.owner_id === owner.owner_id);
      for (const event of ownerEvents) {
        await deleteRecord(event.id);
        
        // Delete all RSVPs for this event
        const eventRsvps = allData.filter(d => d.type === 'rsvp' && d.event_id === event.event_id);
        for (const rsvp of eventRsvps) {
          await deleteRecord(rsvp.id);
        }
      }

      allData = await loadAllData();
      renderAdminDashboard();
    }

    async function adminLoginAsUser(backendId) {
      const owner = allData.find(d => d.id === backendId);
      if (!owner) return;

      // Check if account is approved
      if (owner.account_status !== 'approved') {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Conta n√£o aprovada!';
        btn.classList.add('bg-red-600');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('bg-red-600');
        }, 2000);
        return;
      }

      // Set current owner and save session
      currentOwner = owner;
      localStorage.setItem('rsvp_session', JSON.stringify({ ownerId: owner.owner_id, adminMode: true }));
      
      // Go to owner dashboard
      showView('dashboard-view');
      renderDashboard();
    }

    // Helpers
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }

    // Initialize app
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c1f808c069d06fb',t:'MTc2OTA4OTYzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>